
[Registry Persistence via Service in Safe Mode]
description = Detects the modification of the registry to allow a driver or service to persist in Safe Mode.
search = TargetObject IN ("*\\Control\\SafeBoot\\Minimal\\*", "*\\Control\\SafeBoot\\Network\\*") TargetObject="*\\(Default)" Details="Service" NOT (Image="C:\\WINDOWS\\system32\\msiexec.exe" TargetObject IN ("*\\Control\\SafeBoot\\Minimal\\SAVService\\(Default)", "*\\Control\\SafeBoot\\Network\\SAVService\\(Default)"))

[Add Port Monitor Persistence in Registry]
description = Adversaries may use port monitors to run an attacker supplied DLL during system boot for persistence or privilege escalation. \
A port monitor can be set through the AddMonitor API call to set a DLL to be loaded at startup.
search = TargetObject="*\\Control\\Print\\Monitors\\*" Details="*.dll" NOT ((Image="C:\\Windows\\System32\\spoolsv.exe" TargetObject="*\\Control\\Print\\Monitors\\CutePDF Writer Monitor v4.0\\Driver*" Details="cpwmon64_v40.dll" User IN ("*AUTHORI*", "*AUTORI*")) OR TargetObject="*\\Control\\Print\\Monitors\\MONVNC\\Driver*" OR (TargetObject="*Control\\Print\\Environments\\*" TargetObject="*\\Drivers\\*" TargetObject="*\\VNC Printer*"))

[Add Debugger Entry To AeDebug For Persistence]
description = Detects when an attacker adds a new "Debugger" value to the "AeDebug" key in order to achieve persistence which will get invoked when an application crashes
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AeDebug\\Debugger*" Details="*.dll" NOT Details="\"C:\\WINDOWS\\system32\\vsjitdebugger.exe\" -p %ld -e %ld -j 0x%p"

[Allow RDP Remote Assistance Feature]
description = Detect enable rdp feature to allow specific user to rdp connect on the targeted machine
search = TargetObject="*System\\CurrentControlSet\\Control\\Terminal Server\\fAllowToGetHelp" Details="DWORD (0x00000001)"

[Potential AMSI COM Server Hijacking]
description = Detects changes to the AMSI come server registry key in order disable AMSI scanning functionalities. When AMSI attempts to starts its COM component, it will query its registered CLSID and return a non-existent COM server. This causes a load failure and prevents any scanning methods from being accessed, ultimately rendering AMSI useless
search = TargetObject="*\\CLSID\\{fdb00e52-a214-4aa1-8fba-4357bb0072ec}\\InProcServer32\\(Default)" NOT Details="%windir%\\system32\\amsi.dll"

[Classes Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\Software\\Classes*" TargetObject IN ("*\\Folder\\ShellEx\\ExtShellFolderViews*", "*\\Folder\\ShellEx\\DragDropHandlers*", "*\\Folder\\Shellex\\ColumnHandlers*", "*\\Filter*", "*\\Exefile\\Shell\\Open\\Command\\(Default)*", "*\\Directory\\Shellex\\DragDropHandlers*", "*\\Directory\\Shellex\\CopyHookHandlers*", "*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance*", "*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance*", "*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance*", "*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance*", "*\\Classes\\AllFileSystemObjects\\ShellEx\\DragDropHandlers*", "*\\.exe*", "*\\.cmd*", "*\\ShellEx\\PropertySheetHandlers*", "*\\ShellEx\\ContextMenuHandlers*") NOT (Details="(Empty)" OR Details="{807583E5-5146-11D5-A672-00B0D022E945}" OR Image="C:\\Windows\\System32\\drvinst.exe" OR (Image="C:\\Windows\\System32\\svchost.exe" TargetObject="*\\lnkfile\\shellex\\ContextMenuHandlers\\*")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Common Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject IN ("*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows CE Services\\AutoStart*", "*\\Software\\Wow6432Node\\Microsoft\\Command Processor\\Autorun*", "*\\SOFTWARE\\Wow6432Node\\Microsoft\\Active Setup\\Installed Components*", "*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect*", "*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect*", "*\\SYSTEM\\Setup\\CmdLine*", "*\\Software\\Microsoft\\Ctf\\LangBarAddin*", "*\\Software\\Microsoft\\Command Processor\\Autorun*", "*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components*", "*\\SOFTWARE\\Classes\\Protocols\\Handler*", "*\\SOFTWARE\\Classes\\Protocols\\Filter*", "*\\SOFTWARE\\Classes\\Htmlfile\\Shell\\Open\\Command\\(Default)*", "*\\Environment\\UserInitMprLogonScript*", "*\\SOFTWARE\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\Scrnsave.exe*", "*\\Software\\Microsoft\\Internet Explorer\\UrlSearchHooks*", "*\\SOFTWARE\\Microsoft\\Internet Explorer\\Desktop\\Components*", "*\\Software\\Classes\\Clsid\\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\\Inprocserver32*", "*\\Control Panel\\Desktop\\Scrnsave.exe*") NOT (Details="(Empty)" OR TargetObject IN ("*\\Office\\ClickToRun\\REGISTRY\\MACHINE\\Software\\Classes\\PROTOCOLS\\Handler\\*", "*\\ClickToRunStore\\HKMU\\SOFTWARE\\Classes\\PROTOCOLS\\Handler\\*") OR Details IN ("{314111c7-a502-11d2-bbca-00c04f8ec294}", "{3459B272-CC19-4448-86C9-DDC3B4B2FAD3}", "{42089D2D-912D-4018-9087-2B87803E93FB}", "{5504BE45-A83B-4808-900A-3A5C36E7F77A}", "{807583E5-5146-11D5-A672-00B0D022E945}") OR TargetObject="*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\{8A69D345-D564-463c-AFF1-A69D9E530F96}*" OR TargetObject="*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\{9459C573-B17A-45AE-9F64-1857B5D58CEE}*" OR TargetObject="*\\Software\\Microsoft\\Active Setup\\Installed Components\\{89820200-ECBD-11cf-8B85-00AA005B4383}*" OR Image IN ("C:\\Windows\\System32\\poqexec.exe", "C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe") OR (Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*") Image="*\\OfficeClickToRun.exe"))

[CurrentControlSet Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\SYSTEM\\CurrentControlSet\\Control*" TargetObject IN ("*\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram*", "*\\Terminal Server\\Wds\\rdpwd\\StartupPrograms*", "*\\SecurityProviders\\SecurityProviders*", "*\\SafeBoot\\AlternateShell*", "*\\Print\\Providers*", "*\\Print\\Monitors*", "*\\NetworkProvider\\Order*", "*\\Lsa\\Notification Packages*", "*\\Lsa\\Authentication Packages*", "*\\BootVerificationProgram\\ImagePath*") NOT (Details="(Empty)" OR (Image="C:\\Windows\\System32\\spoolsv.exe" TargetObject="*\\Print\\Monitors\\CutePDF Writer Monitor*" Details IN ("cpwmon64_v40.dll", "CutePDF Writer")) OR (Image="C:\\Windows\\System32\\spoolsv.exe" TargetObject="*Print\\Monitors\\Appmon\\Ports\\Microsoft.Office.OneNote_*" User IN ("*AUTHORI*", "*AUTORI*")) OR (Image="C:\\Windows\\System32\\poqexec.exe" TargetObject="*\\NetworkProvider\\Order\\ProviderOrder") OR (Image="C:\\Windows\\System32\\spoolsv.exe" TargetObject="*\\Print\\Monitors\\MONVNC\\Driver" Details="VNCpm.dll")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[CurrentVersion Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion*" TargetObject IN ("*\\ShellServiceObjectDelayLoad*", "*\\Run\\*", "*\\RunOnce\\*", "*\\RunOnceEx\\*", "*\\RunServices\\*", "*\\RunServicesOnce\\*", "*\\Policies\\System\\Shell*", "*\\Policies\\Explorer\\Run*", "*\\Group Policy\\Scripts\\Startup*", "*\\Group Policy\\Scripts\\Shutdown*", "*\\Group Policy\\Scripts\\Logon*", "*\\Group Policy\\Scripts\\Logoff*", "*\\Explorer\\ShellServiceObjects*", "*\\Explorer\\ShellIconOverlayIdentifiers*", "*\\Explorer\\ShellExecuteHooks*", "*\\Explorer\\SharedTaskScheduler*", "*\\Explorer\\Browser Helper Objects*", "*\\Authentication\\PLAP Providers*", "*\\Authentication\\Credential Providers*", "*\\Authentication\\Credential Provider Filters*") NOT (Details="(Empty)" OR TargetObject="*\\NgcFirst\\ConsecutiveSwitchCount" OR Image IN ("*\\AppData\\Local\\Microsoft\\OneDrive\\Update\\OneDriveSetup.exe", "*\\AppData\\Roaming\\Spotify\\Spotify.exe", "*\\AppData\\Local\\WebEx\\WebexHost.exe") OR Image IN ("C:\\WINDOWS\\system32\\devicecensus.exe", "C:\\Windows\\system32\\winsat.exe", "C:\\Program Files\\Microsoft OneDrive\\StandaloneUpdater\\OneDriveSetup.exe", "C:\\Program Files\\Microsoft OneDrive\\Update\\OneDriveSetup.exe", "C:\\Program Files (x86)\\Microsoft OneDrive\\Update\\OneDriveSetup.exe", "C:\\Program Files\\KeePass Password Safe 2\\ShInstUtil.exe", "C:\\Program Files\\Everything\\Everything.exe", "C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe") OR (Image="C:\\Windows\\system32\\LogonUI.exe" TargetObject IN ("*\\Authentication\\Credential Providers\\{D6886603-9D2F-4EB2-B667-1971041FA96B}\\*", "*\\Authentication\\Credential Providers\\{BEC09223-B018-416D-A0AC-523971B639F5}\\*", "*\\Authentication\\Credential Providers\\{8AF662BF-65A0-4D0A-A540-A338A999D36F}\\*", "*\\Authentication\\Credential Providers\\{27FBDB57-B613-4AF2-9D7E-4FA7A66C21AD}\\*")) OR Image IN ("C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\*", "C:\\Program Files (x86)\\Microsoft\\EdgeWebView\\*", "C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe*") OR (Image="C:\\Windows\\system32\\regsvr32.exe" TargetObject="*DropboxExt*" Details="*A251-47B7-93E1-CDD82E34AF8B}") OR (TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\Opera Browser Assistant" Details="C:\\Program Files\\Opera\\assistant\\browser_assistant.exe") OR (TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\iTunesHelper" Details="\"C:\\Program Files\\iTunes\\iTunesHelper.exe\"") OR (TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\zoommsirepair" Details="\"C:\\Program Files\\Zoom\\bin\\installer.exe\" /repair") OR (TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\Greenshot" Details="C:\\Program Files\\Greenshot\\Greenshot.exe") OR (TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\GoogleDriveFS" Details="C:\\Program Files\\Google\\Drive File Stream\\*" Details="*\\GoogleDriveFS.exe*") OR (TargetObject="*GoogleDrive*" Details IN ("{CFE8B367-77A7-41D7-9C90-75D16D7DC6B6}", "{A8E52322-8734-481D-A7E2-27B309EF8D56}", "{C973DA94-CBDF-4E77-81D1-E5B794FBD146}", "{51EF1569-67EE-4AD6-9646-E726C3FFC8A2}")) OR (Details IN ("C:\\Windows\\system32\\cmd.exe /q /c rmdir /s /q \"C:\\Users\\*", "C:\\Windows\\system32\\cmd.exe /q /c del /q \"C:\\Users\\*") Details="*\\AppData\\Local\\Microsoft\\OneDrive\\*") OR (TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\{*" Details="*\\AppData\\Local\\Package Cache\\{*" Details="*}\\python-*" Details="*.exe\" /burn.runonce") OR (Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*") Image="*\\OfficeClickToRun.exe") OR Image="C:\\Program Files\\Windows Defender\\MsMpEng.exe" OR (Image="*\\Microsoft\\Teams\\current\\Teams.exe" Details="*\\Microsoft\\Teams\\Update.exe --processStart *") OR (Image="C:\\Windows\\system32\\userinit.exe" Details="ctfmon.exe /n") OR (Image="C:\\Program Files\\AVG\\Antivirus\\Setup\\*" Details IN ("\"C:\\Program Files\\AVG\\Antivirus\\AvLaunch.exe\" /gui", "\"C:\\Program Files (x86)\\AVG\\Antivirus\\AvLaunch.exe\" /gui", "{472083B0-C522-11CF-8763-00608CC02F24}")) OR (Image IN ("*\\aurora-agent-64.exe", "*\\aurora-agent.exe") TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Run\\aurora-dashboard" Details="C:\\Program Files\\Aurora-Agent\\tools\\aurora-dashboard.exe") OR (TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Run\\Everything" Details="*\\Everything\\Everything.exe\" -startup"))

[CurrentVersion NT Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion*" TargetObject IN ("*\\Winlogon\\VmApplet*", "*\\Winlogon\\Userinit*", "*\\Winlogon\\Taskman*", "*\\Winlogon\\Shell*", "*\\Winlogon\\GpExtensions*", "*\\Winlogon\\AppSetup*", "*\\Winlogon\\AlternateShells\\AvailableShells*", "*\\Windows\\IconServiceLib*", "*\\Windows\\Appinit_Dlls*", "*\\Image File Execution Options*", "*\\Font Drivers*", "*\\Drivers32*", "*\\Windows\\Run*", "*\\Windows\\Load*") NOT (Details="(Empty)" OR (TargetObject="*\\Image File Execution Options\\*" TargetObject IN ("*\\DisableExceptionChainValidation", "*\\MitigationOptions")) OR (Image="C:\\Program Files (x86)\\Microsoft\\Temp\\*" Image="*\\MicrosoftEdgeUpdate.exe") OR TargetObject IN ("*\\ClickToRunStore\\HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\*", "*\\ClickToRun\\REGISTRY\\MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\*") OR Image IN ("C:\\Program Files\\Microsoft Office\\root\\integration\\integrator.exe", "C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe") OR (Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*") Image="*\\OfficeClickToRun.exe") OR (Image="C:\\Windows\\system32\\svchost.exe" TargetObject IN ("*\\Winlogon\\GPExtensions\\{827D319E-6EAC-11D2-A4EA-00C04F79F83A}\\PreviousPolicyAreas*", "*\\Winlogon\\GPExtensions\\{827D319E-6EAC-11D2-A4EA-00C04F79F83A}\\MaxNoGPOListChangesInterval*") Details IN ("DWORD (0x00000009)", "DWORD (0x000003c0)")) OR (Image="C:\\Windows\\Microsoft.NET\\Framework*" Image="*\\ngen.exe") OR (Image="*\\AppData\\Local\\Microsoft\\OneDrive\\StandaloneUpdater\\OneDriveSetup.exe" TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\Delete Cached Update Binary" Details="C:\\Windows\\system32\\cmd.exe /q /c del /q \"C:\\Users\\*" Details="*\\AppData\\Local\\Microsoft\\OneDrive\\Update\\OneDriveSetup.exe\"")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Internet Explorer Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject IN ("*\\Software\\Wow6432Node\\Microsoft\\Internet Explorer*", "*\\Software\\Microsoft\\Internet Explorer*") TargetObject IN ("*\\Toolbar*", "*\\Extensions*", "*\\Explorer Bars*") NOT (Details="(Empty)" OR TargetObject IN ("*\\Extensions\\{2670000A-7350-4f3c-8081-5663EE0C6C49}*", "*\\Extensions\\{31D09BA0-12F5-4CCE-BE8A-2923E76605DA}*", "*\\Extensions\\{789FE86F-6FC4-46A1-9849-EDE0DB0C95CA}*", "*\\Extensions\\{A95fe080-8f5d-11d2-a20b-00aa003c157a}*") OR TargetObject IN ("*\\Toolbar\\ShellBrowser\\ITBar7Layout", "*\\Toolbar\\ShowDiscussionButton", "*\\Toolbar\\Locked")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Office Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject IN ("*\\Software\\Wow6432Node\\Microsoft\\Office*", "*\\Software\\Microsoft\\Office*") TargetObject IN ("*\\Word\\Addins*", "*\\PowerPoint\\Addins*", "*\\Outlook\\Addins*", "*\\Onenote\\Addins*", "*\\Excel\\Addins*", "*\\Access\\Addins*", "*test\\Special\\Perf*") NOT (Details="(Empty)" OR (Image IN ("C:\\Program Files\\Microsoft Office\\*", "C:\\Program Files (x86)\\Microsoft Office\\*", "C:\\Windows\\System32\\msiexec.exe*", "C:\\Windows\\System32\\regsvr32.exe*") TargetObject IN ("*\\Excel\\Addins\\AdHocReportingExcelClientLib.AdHocReportingExcelClientAddIn.1\\*", "*\\Excel\\Addins\\ExcelPlugInShell.PowerMapConnect\\*", "*\\Excel\\Addins\\NativeShim\\*", "*\\Excel\\Addins\\NativeShim.InquireConnector.1\\*", "*\\Excel\\Addins\\PowerPivotExcelClientAddIn.NativeEntry.1\\*", "*\\Outlook\\AddIns\\AccessAddin.DC\\*", "*\\Outlook\\AddIns\\ColleagueImport.ColleagueImportAddin\\*", "*\\Outlook\\AddIns\\EvernoteCC.EvernoteContactConnector\\*", "*\\Outlook\\AddIns\\EvernoteOLRD.Connect\\*", "*\\Outlook\\Addins\\Microsoft.VbaAddinForOutlook.1\\*", "*\\Outlook\\Addins\\OcOffice.OcForms\\*", "*\\Outlook\\Addins\\OneNote.OutlookAddin*", "*\\Outlook\\Addins\\OscAddin.Connect\\*", "*\\Outlook\\Addins\\OutlookChangeNotifier.Connect\\*", "*\\Outlook\\Addins\\UCAddin.LyncAddin.1*", "*\\Outlook\\Addins\\UCAddin.UCAddin.1*", "*\\Outlook\\Addins\\UmOutlookAddin.FormRegionAddin\\*")) OR (Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*") Image="*\\OfficeClickToRun.exe") OR (Image="C:\\Program Files\\AVG\\Antivirus\\RegSvr.exe" TargetObject="*\\Microsoft\\Office\\Outlook\\Addins\\Antivirus.AsOutExt\\*")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Session Manager Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\System\\CurrentControlSet\\Control\\Session Manager*" TargetObject IN ("*\\SetupExecute*", "*\\S0InitialCommand*", "*\\KnownDlls*", "*\\Execute*", "*\\BootExecute*", "*\\AppCertDlls*") NOT Details="(Empty)" \
| table SecurityID,ObjectName,OldValueType,NewValueType

[System Scripts Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\Software\\Policies\\Microsoft\\Windows\\System\\Scripts*" TargetObject IN ("*\\Startup*", "*\\Shutdown*", "*\\Logon*", "*\\Logoff*") NOT Details="(Empty)" \
| table SecurityID,ObjectName,OldValueType,NewValueType

[WinSock2 Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\System\\CurrentControlSet\\Services\\WinSock2\\Parameters*" TargetObject IN ("*\\Protocol_Catalog9\\Catalog_Entries*", "*\\NameSpace_Catalog5\\Catalog_Entries*") NOT (Details="(Empty)" OR Image="C:\\Windows\\System32\\MsiExec.exe" OR Image="C:\\Windows\\syswow64\\MsiExec.exe") \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Wow6432Node CurrentVersion Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion*" TargetObject IN ("*\\ShellServiceObjectDelayLoad*", "*\\Run\\*", "*\\RunOnce\\*", "*\\RunOnceEx\\*", "*\\RunServices\\*", "*\\RunServicesOnce\\*", "*\\Explorer\\ShellServiceObjects*", "*\\Explorer\\ShellIconOverlayIdentifiers*", "*\\Explorer\\ShellExecuteHooks*", "*\\Explorer\\SharedTaskScheduler*", "*\\Explorer\\Browser Helper Objects*") NOT (Details="(Empty)" OR (Image="*C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{*" Image="*\\setup.exe*") OR (Image="C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\OfficeClickToRun.exe" TargetObject="*\\Office\\ClickToRun\\REGISTRY\\MACHINE\\Software\\Wow6432Node\\*") OR (Image IN ("C:\\Program Files\\Microsoft Office\\root\\integration\\integrator.exe", "C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe") TargetObject="*\\Explorer\\Browser Helper Objects\\{31D09BA0-12F5-4CCE-BE8A-2923E76605DA}\\*") OR Details="*-A251-47B7-93E1-CDD82E34AF8B}" OR Details="grpconv -o" OR (Details="*C:\\Program Files*" Details="*\\Dropbox\\Client\\Dropbox.exe*" Details="* /systemstartup*") OR TargetObject="*\\Explorer\\Browser Helper Objects\\{92EF2EAD-A7CE-4424-B0DB-499CF856608E}\\NoExplorer" OR (Image="*\\windowsdesktop-runtime-*" TargetObject IN ("*\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\{e2d1ae32-dd1d-4ad7-a298-10e42e7840fc}", "*\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\{7037b699-7382-448c-89a7-4765961d2537}") Details="\"C:\\ProgramData\\Package Cache\\*" Details="*.exe\" /burn.runonce") OR (Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*") Image="*\\OfficeClickToRun.exe") OR Details="\"C:\\ProgramData\\Package Cache\\{d21a4f20-968a-4b0c-bf04-a38da5f06e41}\\windowsdesktop-runtime-*" OR (Image="*\\VC_redist.x64.exe" Details="*}\\VC_redist.x64.exe\" /burn.runonce") OR (Image IN ("C:\\ProgramData\\Package Cache*", "C:\\Windows\\Temp\\*") Image IN ("*\\winsdksetup.exe*", "*\\windowsdesktop-runtime-*", "*\\AspNetCoreSharedFrameworkBundle-*") Details="* /burn.runonce") OR (Image="C:\\Windows\\Installer\\MSI*" TargetObject="*\\Explorer\\Browser Helper Objects*") OR (Image="C:\\WINDOWS\\system32\\msiexec.exe" TargetObject="*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\*")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Wow6432Node Classes Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\Software\\Wow6432Node\\Classes*" TargetObject IN ("*\\Folder\\ShellEx\\ExtShellFolderViews*", "*\\Folder\\ShellEx\\DragDropHandlers*", "*\\Folder\\ShellEx\\ColumnHandlers*", "*\\Directory\\Shellex\\DragDropHandlers*", "*\\Directory\\Shellex\\CopyHookHandlers*", "*\\CLSID\\{AC757296-3522-4E11-9862-C17BE5A1767E}\\Instance*", "*\\CLSID\\{ABE3B9A4-257D-4B97-BD1A-294AF496222E}\\Instance*", "*\\CLSID\\{7ED96837-96F0-4812-B211-F13C24117ED3}\\Instance*", "*\\CLSID\\{083863F1-70DE-11d0-BD40-00A0C911CE86}\\Instance*", "*\\AllFileSystemObjects\\ShellEx\\DragDropHandlers*", "*\\ShellEx\\PropertySheetHandlers*", "*\\ShellEx\\ContextMenuHandlers*") NOT Details="(Empty)" \
| table SecurityID,ObjectName,OldValueType,NewValueType

[Wow6432Node Windows NT CurrentVersion Autorun Keys Modification]
description = Detects modification of autostart extensibility point (ASEP) in registry.
search = TargetObject="*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion*" TargetObject IN ("*\\Windows\\Appinit_Dlls*", "*\\Image File Execution Options*", "*\\Drivers32*") NOT (Details IN ("(Empty)", "\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options")) \
| table SecurityID,ObjectName,OldValueType,NewValueType

[New BgInfo.EXE Custom DB Path Registry Configuration]
description = Detects setting of a new registry database value related to BgInfo configuration. Attackers can for example set this value to save the results of the commands executed by BgInfo in order to exfiltrate information.
search = EventType="SetValue" TargetObject="*\\Software\\Winternals\\BGInfo\\Database"

[New BgInfo.EXE Custom VBScript Registry Configuration]
description = Detects setting of a new registry value related to BgInfo configuration, which can be abused to execute custom VBScript via "BgInfo.exe"
search = EventType="SetValue" TargetObject="*\\Software\\Winternals\\BGInfo\\UserFields\\*" Details="4*"

[New BgInfo.EXE Custom WMI Query Registry Configuration]
description = Detects setting of a new registry value related to BgInfo configuration, which can be abused to execute custom WMI query via "BgInfo.exe"
search = EventType="SetValue" TargetObject="*\\Software\\Winternals\\BGInfo\\UserFields\\*" Details="6*"

[Blackbyte Ransomware Registry]
description = BlackByte set three different registry values to escalate privileges and begin setting the stage for lateral movement and encryption
search = TargetObject IN ("HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LocalAccountTokenFilterPolicy", "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLinkedConnections", "HKLM\\SYSTEM\\CurrentControlSet\\Control\\FileSystem\\LongPathsEnabled") Details="DWORD (0x00000001)"

[Bypass UAC Using DelegateExecute]
description = Bypasses User Account Control using a fileless method
search = TargetObject="*\\open\\command\\DelegateExecute" Details="(Empty)"

[Bypass UAC Using Event Viewer]
description = Bypasses User Account Control using Event Viewer and a relevant Windows Registry modification
search = TargetObject="*_Classes\\mscfile\\shell\\open\\command\\(Default)" NOT Details="%SystemRoot%\\system32\\mmc.exe \"%1\" %*"

[Bypass UAC Using SilentCleanup Task]
description = Detects the setting of the environement variable "windir" to a non default value. \
Attackers often abuse this variable in order to trigger a UAC bypass via the "SilentCleanup" task. \
The SilentCleanup task located in %windir%\system32\cleanmgr.exe is an auto-elevated task that can be abused to elevate any file with administrator privileges without prompting UAC.
search = TargetObject="*\\Environment\\windir" NOT Details="%SystemRoot%"

[Default RDP Port Changed to Non Standard Port]
description = Detects changes to the default RDP port. \
Remote desktop is a common feature in operating systems. It allows a user to log into a remote system using an interactive session with a graphical user interface. \
Microsoft refers to its implementation of the Remote Desktop Protocol (RDP) as Remote Desktop Services (RDS).
search = TargetObject="*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\PortNumber" NOT Details="DWORD (0x00000d3d)"

[IE Change Domain Zone]
description = Hides the file extension through modification of the registry
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\Domains\\*" NOT (Details IN ("DWORD (0x00000000)", "DWORD (0x00000001)", "(Empty)"))

[Sysmon Driver Altitude Change]
description = Detects changes in Sysmon driver altitude value. \
If the Sysmon driver is configured to load at an altitude of another registered service, it will fail to load at boot.
search = TargetObject="*\\Services\\*" TargetObject="*\\Instances\\Sysmon Instance\\Altitude"

[Change Winevt Channel Access Permission Via Registry]
description = Detects tampering with the "ChannelAccess" registry key in order to change access to Windows event channel.
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\*" TargetObject="*\\ChannelAccess" Details IN ("*(A;;0x1;;;LA)*", "*(A;;0x1;;;SY)*", "*(A;;0x5;;;BA)*") NOT (Image="C:\\Windows\\servicing\\TrustedInstaller.exe" OR (Image="C:\\Windows\\WinSxS\\*" Image="*\\TiWorker.exe"))

[Running Chrome VPN Extensions via the Registry 2 VPN Extension]
description = Running Chrome VPN Extensions via the Registry install 2 vpn extension
search = TargetObject="*Software\\Wow6432Node\\Google\\Chrome\\Extensions*" TargetObject="*update_url" TargetObject IN ("*fdcgdnkidjaadafnichfpabhfomcebme*", "*fcfhplploccackoneaefokcmbjfbkenj*", "*bihmplhobchoageeokmgbdihknkjbknd*", "*gkojfkhlekighikafcpjkiklfbnlmeio*", "*jajilbjjinjmgcibalaakngmkilboobh*", "*gjknjjomckknofjidppipffbpoekiipm*", "*nabbmpekekjknlbkgpodfndbodhijjem*", "*kpiecbcckbofpmkkkdibbllpinceiihk*", "*nlbejmccbhkncgokjcmghpfloaajcffj*", "*omghfjlpggmjjaagoclmmobgdodcjboh*", "*bibjcjfmgapbfoljiojpipaooddpkpai*", "*mpcaainmfjjigeicjnlkdfajbioopjko*", "*jljopmgdobloagejpohpldgkiellmfnc*", "*lochiccbgeohimldjooaakjllnafhaid*", "*nhnfcgpcbfclhfafjlooihdfghaeinfc*", "*ookhnhpkphagefgdiemllfajmkdkcaim*", "*namfblliamklmeodpcelkokjbffgmeoo*", "*nbcojefnccbanplpoffopkoepjmhgdgh*", "*majdfhpaihoncoakbjgbdhglocklcgno*", "*lnfdmdhmfbimhhpaeocncdlhiodoblbd*", "*eppiocemhmnlbhjplcgkofciiegomcon*", "*cocfojppfigjeefejbpfmedgjbpchcng*", "*foiopecknacmiihiocgdjgbjokkpkohc*", "*hhdobjgopfphlmjbmnpglhfcgppchgje*", "*jgbaghohigdbgbolncodkdlpenhcmcge*", "*inligpkjkhbpifecbdjhmdpcfhnlelja*", "*higioemojdadgdbhbbbkfbebbdlfjbip*", "*hipncndjamdcmphkgngojegjblibadbe*", "*iolonopooapdagdemdoaihahlfkncfgg*", "*nhfjkakglbnnpkpldhjmpmmfefifedcj*", "*jpgljfpmoofbmlieejglhonfofmahini*", "*fgddmllnllkalaagkghckoinaemmogpe*", "*ejkaocphofnobjdedneohbbiilggdlbi*", "*keodbianoliadkoelloecbhllnpiocoi*", "*hoapmlpnmpaehilehggglehfdlnoegck*", "*poeojclicodamonabcabmapamjkkmnnk*", "*dfkdflfgjdajbhocmfjolpjbebdkcjog*", "*kcdahmgmaagjhocpipbodaokikjkampi*", "*klnkiajpmpkkkgpgbogmcgfjhdoljacg*", "*lneaocagcijjdpkcabeanfpdbmapcjjg*", "*pgfpignfckbloagkfnamnolkeaecfgfh*", "*jplnlifepflhkbkgonidnobkakhmpnmh*", "*jliodmnojccaloajphkingdnpljdhdok*", "*hnmpcagpplmpfojmgmnngilcnanddlhb*", "*ffbkglfijbcbgblgflchnbphjdllaogb*", "*kcndmbbelllkmioekdagahekgimemejo*", "*jdgilggpfmjpbodmhndmhojklgfdlhob*", "*bihhflimonbpcfagfadcnbbdngpopnjb*", "*ppajinakbfocjfnijggfndbdmjggcmde*", "*oofgbpoabipfcfjapgnbbjjaenockbdp*", "*bhnhkdgoefpmekcgnccpnhjfdgicfebm*", "*knmmpciebaoojcpjjoeonlcjacjopcpf*", "*dhadilbmmjiooceioladdphemaliiobo*", "*jedieiamjmoflcknjdjhpieklepfglin*", "*mhngpdlhojliikfknhfaglpnddniijfh*", "*omdakjcmkglenbhjadbccaookpfjihpa*", "*npgimkapccfidfkfoklhpkgmhgfejhbj*", "*akeehkgglkmpapdnanoochpfmeghfdln*", "*gbmdmipapolaohpinhblmcnpmmlgfgje*", "*aigmfoeogfnljhnofglledbhhfegannp*", "*cgojmfochfikphincbhokimmmjenhhgk*", "*ficajfeojakddincjafebjmfiefcmanc*", "*ifnaibldjfdmaipaddffmgcmekjhiloa*", "*jbnmpdkcfkochpanomnkhnafobppmccn*", "*apcfdffemoinopelidncddjbhkiblecc*", "*mjolnodfokkkaichkcjipfgblbfgojpa*", "*oifjbnnafapeiknapihcmpeodaeblbkn*", "*plpmggfglncceinmilojdkiijhmajkjh*", "*mjnbclmflcpookeapghfhapeffmpodij*", "*bblcccknbdbplgmdjnnikffefhdlobhp*", "*aojlhgbkmkahabcmcpifbolnoichfeep*", "*lcmammnjlbmlbcaniggmlejfjpjagiia*", "*knajdeaocbpmfghhmijicidfcmdgbdpm*", "*bdlcnpceagnkjnjlbbbcepohejbheilk*", "*edknjdjielmpdlnllkdmaghlbpnmjmgb*", "*eidnihaadmmancegllknfbliaijfmkgo*", "*ckiahbcmlmkpfiijecbpflfahoimklke*", "*macdlemfnignjhclfcfichcdhiomgjjb*", "*chioafkonnhbpajpengbalkececleldf*", "*amnoibeflfphhplmckdbiajkjaoomgnj*", "*llbhddikeonkpbhpncnhialfbpnilcnc*", "*pcienlhnoficegnepejpfiklggkioccm*", "*iocnglnmfkgfedpcemdflhkchokkfeii*", "*igahhbkcppaollcjeaaoapkijbnphfhb*", "*njpmifchgidinihmijhcfpbdmglecdlb*", "*ggackgngljinccllcmbgnpgpllcjepgc*", "*kchocjcihdgkoplngjemhpplmmloanja*", "*bnijmipndnicefcdbhgcjoognndbgkep*", "*lklekjodgannjcccdlbicoamibgbdnmi*", "*dbdbnchagbkhknegmhgikkleoogjcfge*", "*egblhcjfjmbjajhjhpmnlekffgaemgfh*", "*ehbhfpfdkmhcpaehaooegfdflljcnfec*", "*bkkgdjpomdnfemhhkalfkogckjdkcjkg*", "*almalgbpmcfpdaopimbdchdliminoign*", "*akkbkhnikoeojlhiiomohpdnkhbkhieh*", "*gbfgfbopcfokdpkdigfmoeaajfmpkbnh*", "*bniikohfmajhdcffljgfeiklcbgffppl*", "*lejgfmmlngaigdmmikblappdafcmkndb*", "*ffhhkmlgedgcliajaedapkdfigdobcif*", "*gcknhkkoolaabfmlnjonogaaifnjlfnp*", "*pooljnboifbodgifngpppfklhifechoe*", "*fjoaledfpmneenckfbpdfhkmimnjocfa*", "*aakchaleigkohafkfjfjbblobjifikek*", "*dpplabbmogkhghncfbfdeeokoefdjegm*", "*padekgcemlokbadohgkifijomclgjgif*", "*bfidboloedlamgdmenmlbipfnccokknp*")

[ClickOnce Trust Prompt Tampering]
description = Detects changes to the ClickOnce trust prompt registry key in order to enable an installation from different locations such as the Internet.
search = TargetObject="*\\SOFTWARE\\MICROSOFT\\.NETFramework\\Security\\TrustManager\\PromptingLevel\\*" TargetObject IN ("*\\Internet", "*\\LocalIntranet", "*\\MyComputer", "*\\TrustedSites", "*\\UntrustedSites") Details="Enabled"

[Potential CobaltStrike Service Installations - Registry]
description = Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement.
search = TargetObject="*\\System\\CurrentControlSet\\Services*" OR (TargetObject="*\\System\\ControlSet*" TargetObject="*\\Services*") (Details="*ADMIN$*" Details="*.exe*") OR (Details="*%COMSPEC%*" Details="*start*" Details="*powershell*")

[COM Hijack via Sdclt]
description = Detects changes to 'HKCU\Software\Classes\Folder\shell\open\command\DelegateExecute'
search = TargetObject="*\\Software\\Classes\\Folder\\shell\\open\\command\\DelegateExecute*"

[CrashControl CrashDump Disabled]
description = Detects disabling the CrashDump per registry (as used by HermeticWiper)
search = TargetObject="*SYSTEM\\CurrentControlSet\\Control\\CrashControl*" Details="DWORD (0x00000000)"

[Service Binary in Suspicious Folder]
description = Detect the creation of a service with a service binary located in a suspicious directory
search = (TargetObject="HKLM\\System\\CurrentControlSet\\Services\\*" TargetObject="*\\Start" Image IN ("*\\Users\\Public\\*", "*\\Perflogs\\*", "*\\ADMIN$\\*", "*\\Temp\\*") Details IN ("DWORD (0x00000000)", "DWORD (0x00000001)", "DWORD (0x00000002)")) OR (TargetObject="HKLM\\System\\CurrentControlSet\\Services\\*" TargetObject="*\\ImagePath" Details IN ("*\\Users\\Public\\*", "*\\Perflogs\\*", "*\\ADMIN$\\*", "*\\Temp\\*")) NOT (Image="*\\Common Files\\*" Image="*\\Temp\\*")

[Custom File Open Handler Executes PowerShell]
description = Detects the abuse of custom file open handler, executing powershell
search = TargetObject="*shell\\open\\command\\*" Details="*powershell*" Details="*-command*"

[Potential Registry Persistence Attempt Via DbgManagedDebugger]
description = Detects the addition of the "Debugger" value to the "DbgManagedDebugger" key in order to achieve persistence. Which will get invoked when an application crashes
search = TargetObject="*\\Microsoft\\.NETFramework\\DbgManagedDebugger" NOT Details="\"C:\\Windows\\system32\\vsjitdebugger.exe\" PID %d APPDOM %d EXTEXT \"%s\" EVTHDL %d"

[Windows Defender Exclusions Added - Registry]
description = Detects the Setting of Windows Defender Exclusions
search = TargetObject="*\\Microsoft\\Windows Defender\\Exclusions*"

[Potentially Suspicious Desktop Background Change Via Registry]
description = Detects regsitry value settings that would replace the user's desktop background. \
This is a common technique used by malware to change the desktop background to a ransom note or other image.
search = TargetObject IN ("*Control Panel\\Desktop*", "*CurrentVersion\\Policies\\ActiveDesktop*", "*CurrentVersion\\Policies\\System*") (TargetObject="*NoChangingWallpaper" Details="DWORD (0x00000001)") OR TargetObject="*\\Wallpaper" OR (TargetObject="*\\WallpaperStyle" Details="2") NOT Image="*\\svchost.exe"

[Hypervisor Enforced Code Integrity Disabled]
description = Detects changes to the HypervisorEnforcedCodeIntegrity registry key and the "Enabled" value being set to 0 in order to disable the Hypervisor Enforced Code Integrity feature. This allows an attacker to load unsigned and untrusted code to be run in the kernel
search = EventType="SetValue" TargetObject IN ("*\\Microsoft\\Windows\\DeviceGuard\\HypervisorEnforcedCodeIntegrity", "*\\Control\\DeviceGuard\\HypervisorEnforcedCodeIntegrity", "*\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\\Enabled") Details="DWORD (0x00000000)"

[DHCP Callout DLL Installation]
description = Detects the installation of a Callout DLL via CalloutDlls and CalloutEnabled parameter in Registry, which can be used to execute code in context of the DHCP server (restart required)
search = TargetObject IN ("*\\Services\\DHCPServer\\Parameters\\CalloutDlls", "*\\Services\\DHCPServer\\Parameters\\CalloutEnabled")

[Disable Exploit Guard Network Protection on Windows Defender]
description = Detects disabling Windows Defender Exploit Guard Network Protection
search = TargetObject="*SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\App and Browser protection\\DisallowExploitProtectionOverride*" Details="DWORD (00000001)"

[Disabled Windows Defender Eventlog]
description = Detects the disabling of the Windows Defender eventlog as seen in relation to Lockbit 3.0 infections
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-Windows Defender/Operational\\Enabled*" Details="DWORD (0x00000000)"

[Disable PUA Protection on Windows Defender]
description = Detects disabling Windows Defender PUA protection
search = TargetObject="*\\Policies\\Microsoft\\Windows Defender\\PUAProtection*" Details="DWORD (0x00000000)"

[Disable Tamper Protection on Windows Defender]
description = Detects disabling Windows Defender Tamper Protection
search = TargetObject="*\\Microsoft\\Windows Defender\\Features\\TamperProtection*" Details="DWORD (0x00000000)" NOT ((Image="C:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*" Image="*\\MsMpEng.exe") OR Image="C:\\Program Files\\Windows Defender\\MsMpEng.exe")

[Disable Administrative Share Creation at Startup]
description = Administrative shares are hidden network shares created by Microsoft Windows NT operating systems that grant system administrators remote access to every disk volume on a network-connected system
search = TargetObject="*\\Services\\LanmanServer\\Parameters\\*" TargetObject IN ("*\\AutoShareWks", "*\\AutoShareServer") Details="DWORD (0x00000000)"

[Potential AutoLogger Sessions Tampering]
description = Detects tampering with autologger trace sessions which is a technique used by attackers to disable logging
search = TargetObject="*\\System\\CurrentControlSet\\Control\\WMI\\Autologger\\*" TargetObject IN ("*\\EventLog-*", "*\\Defender*") TargetObject IN ("*\\Enable", "*\\Start") Details="DWORD (0x00000000)" NOT Image="C:\\Windows\\system32\\wevtutil.exe"

[Disable Microsoft Defender Firewall via Registry]
description = Adversaries may disable or modify system firewalls in order to bypass controls limiting network usage
search = TargetObject="*\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\*" TargetObject="*\\EnableFirewall" Details="DWORD (0x00000000)"

[Disable Internal Tools or Feature in Registry]
description = Detects registry modifications that change features of internal Windows tools (malware like Agent Tesla uses this technique)
search = (TargetObject IN ("*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\StartMenuLogOff", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableChangePassword", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableLockWorkstation", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableRegistryTools", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\DisableTaskmgr", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoDispBackgroundPage", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\NoDispCPL", "*SOFTWARE\\Policies\\Microsoft\\Windows\\Explorer\\DisableNotificationCenter", "*SOFTWARE\\Policies\\Microsoft\\Windows\\System\\DisableCMD") Details="DWORD (0x00000001)") OR (TargetObject IN ("*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\ConsentPromptBehaviorAdmin", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\shutdownwithoutlogon", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PushNotifications\\ToastEnabled", "*SYSTEM\\CurrentControlSet\\Control\\Storage\\Write Protection", "*SYSTEM\\CurrentControlSet\\Control\\StorageDevicePolicies\\WriteProtect") Details="DWORD (0x00000000)")

[Disable Macro Runtime Scan Scope]
description = Detects tampering with the MacroRuntimeScanScope registry key to disable runtime scanning of enabled macros
search = TargetObject="*\\SOFTWARE\\*" TargetObject="*\\Microsoft\\Office\\*" TargetObject="*\\Common\\Security*" TargetObject="*\\MacroRuntimeScanScope" Details="DWORD (0x00000000)"

[Disable Privacy Settings Experience in Registry]
description = Detects registry modifications that disable Privacy Settings Experience
search = TargetObject="*\\SOFTWARE\\Policies\\Microsoft\\Windows\\OOBE\\DisablePrivacyExperience" Details="DWORD (0x00000000)"

[Disable Windows Security Center Notifications]
description = Detect set UseActionCenterExperience to 0 to disable the Windows security center notification
search = TargetObject="*Windows\\CurrentVersion\\ImmersiveShell\\UseActionCenterExperience" Details="DWORD (0x00000000)"

[Registry Disable System Restore]
description = Detects the modification of the registry to disable a system restore on the computer
search = TargetObject IN ("*\\Policies\\Microsoft\\Windows NT\\SystemRestore*", "*\\Microsoft\\Windows NT\\CurrentVersion\\SystemRestore*") TargetObject IN ("*DisableConfig", "*DisableSR") Details="DWORD (0x00000001)"

[Disable Windows Firewall by Registry]
description = Detect set EnableFirewall to 0 to disable the Windows firewall
search = TargetObject IN ("*\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\StandardProfile\\EnableFirewall", "*\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\DomainProfile\\EnableFirewall") Details="DWORD (0x00000000)"

[Disable Windows Event Logging Via Registry]
description = Detects tampering with the "Enabled" registry key in order to disable Windows logging of a Windows event channel
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\*" TargetObject="*\\Enabled" Details="DWORD (0x00000000)" NOT (Image="C:\\Windows\\system32\\wevtutil.exe" OR (Image="C:\\Windows\\winsxs\\*" Image="*\\TiWorker.exe") OR (Image="C:\\Windows\\System32\\svchost.exe" TargetObject IN ("*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-FileInfoMinifilter*", "*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-ASN1\\*", "*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-Kernel-AppCompat\\*", "*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-Runtime\\Error\\*", "*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-CAPI2/Operational\\*")) OR (Image="C:\\Windows\\servicing\\TrustedInstaller.exe" TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels\\Microsoft-Windows-Compat-Appraiser*")) NOT (Image="" OR Image!=*)

[Add DisallowRun Execution to Registry]
description = Detect set DisallowRun to 1 to prevent user running specific computer program
search = TargetObject="*Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\DisallowRun" Details="DWORD (0x00000001)"

[Persistence Via Disk Cleanup Handler - Autorun]
description = Detects when an attacker modifies values of the Disk Cleanup Handler in the registry to achieve persistence via autorun. \
The disk cleanup manager is part of the operating system. \
It displays the dialog box [â€¦] The user has the option of enabling or disabling individual handlers by selecting or clearing their check box in the disk cleanup manager's UI. \
Although Windows comes with a number of disk cleanup handlers, they aren't designed to handle files produced by other applications. \
Instead, the disk cleanup manager is designed to be flexible and extensible by enabling any developer to implement and register their own disk cleanup handler. \
Any developer can extend the available disk cleanup services by implementing and registering a disk cleanup handler.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VolumeCaches\\*" (TargetObject="*\\Autorun*" Details="DWORD (0x00000001)") OR (TargetObject IN ("*\\CleanupString*", "*\\PreCleanupString*") Details IN ("*cmd*", "*powershell*", "*rundll32*", "*mshta*", "*cscript*", "*wscript*", "*wsl*", "*\\Users\\Public\\*", "*\\Windows\\TEMP\\*", "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*"))

[DNS-over-HTTPS Enabled by Registry]
description = Detects when a user enables DNS-over-HTTPS. \
This can be used to hide internet activity or be used to hide the process of exfiltrating data. \
With this enabled organization will lose visibility into data such as query type, response and originating IP that are used to determine bad actors.
search = (TargetObject="*\\SOFTWARE\\Policies\\Microsoft\\Edge\\BuiltInDnsClientEnabled" Details="DWORD (0x00000001)") OR (TargetObject="*\\SOFTWARE\\Google\\Chrome\\DnsOverHttpsMode" Details="secure") OR (TargetObject="*\\SOFTWARE\\Policies\\Mozilla\\Firefox\\DNSOverHTTPS\\Enabled" Details="DWORD (0x00000001)")

[New DNS ServerLevelPluginDll Installed]
description = Detects the installation of a DNS plugin DLL via ServerLevelPluginDll parameter in registry, which can be used to execute code in context of the DNS server (restart required)
search = TargetObject="*\\services\\DNS\\Parameters\\ServerLevelPluginDll"

[ETW Logging Disabled In .NET Processes - Sysmon Registry]
description = Potential adversaries stopping ETW providers recording loaded .NET assemblies.
search = (TargetObject="*SOFTWARE\\Microsoft\\.NETFramework\\ETWEnabled" Details="DWORD (0x00000000)") OR (TargetObject IN ("*\\COMPlus_ETWEnabled", "*\\COMPlus_ETWFlags") Details IN (0, "DWORD (0x00000000)"))

[Windows Recall Feature Enabled - Registry]
description = Detects the enabling of the Windows Recall feature via registry manipulation. Windows Recall can be enabled by setting the value of "DisableAIDataAnalysis" to "0". \
Adversaries may enable Windows Recall as part of post-exploitation discovery and collection activities. \
This rule assumes that Recall is already explicitly disabled on the host, and subsequently enabled by the adversary.
search = TargetObject="*\\Software\\Policies\\Microsoft\\Windows\\WindowsAI\\DisableAIDataAnalysis" Details="DWORD (0x00000000)"

[Enabling COR Profiler Environment Variables]
description = Detects .NET Framework CLR and .NET Core CLR "cor_enable_profiling" and "cor_profiler" variables being set and configured.
search = TargetObject IN ("*\\COR_ENABLE_PROFILING", "*\\COR_PROFILER", "*\\CORECLR_ENABLE_PROFILING") OR TargetObject="*\\CORECLR_PROFILER_PATH*"

[Scripted Diagnostics Turn Off Check Enabled - Registry]
description = Detects enabling TurnOffCheck which can be used to bypass defense of MSDT Follina vulnerability
search = TargetObject="*\\Policies\\Microsoft\\Windows\\ScriptedDiagnostics\\TurnOffCheck" Details="DWORD (0x00000001)"

[Potential EventLog File Location Tampering]
description = Detects tampering with EventLog service "file" key. In order to change the default location of an Evtx file. This technique is used to tamper with log collection and alerting
search = TargetObject="*\\SYSTEM\\CurrentControlSet\\Services\\EventLog\\*" TargetObject="*\\File" NOT Details="*\\System32\\Winevt\\Logs\\*"

[Suspicious Application Allowed Through Exploit Guard]
description = Detects applications being added to the "allowed applications" list of exploit guard in order to bypass controlled folder settings
search = TargetObject="*SOFTWARE\\Microsoft\\Windows Defender\\Windows Defender Exploit Guard\\Controlled Folder Access\\AllowedApplications*" TargetObject IN ("*\\Users\\Public\\*", "*\\AppData\\Local\\Temp\\*", "*\\Desktop\\*", "*\\PerfLogs\\*", "*\\Windows\\Temp\\*")

[Change User Account Associated with the FAX Service]
description = Detect change of the user account associated with the FAX service to avoid the escalation problem.
search = TargetObject="HKLM\\System\\CurrentControlSet\\Services\\Fax\\ObjectName" NOT Details="*NetworkService*"

[Change the Fax Dll]
description = Detect possible persistence using Fax DLL load when service restart
search = TargetObject="*\\Software\\Microsoft\\Fax\\Device Providers\\*" TargetObject="*\\ImageName*" NOT Details="%systemroot%\\system32\\fxst30.dll"

[New File Association Using Exefile]
description = Detects the abuse of the exefile handler in new file association. Used for bypass of security products.
search = TargetObject="*Classes\\.*" Details="exefile"

[Add Debugger Entry To Hangs Key For Persistence]
description = Detects when an attacker adds a new "Debugger" value to the "Hangs" key in order to achieve persistence which will get invoked when an application crashes
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\Hangs\\Debugger*"

[Persistence Via Hhctrl.ocx]
description = Detects when an attacker modifies the registry value of the "hhctrl" to point to a custom binary
search = TargetObject="*\\CLSID\\{52A2AAAE-085D-4187-97EA-8C30DB990436}\\InprocServer32\\(Default)*" NOT Details="C:\\Windows\\System32\\hhctrl.ocx"

[Registry Modification to Hidden File Extension]
description = Hides the file extension through modification of the registry
search = (TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\HideFileExt" Details="DWORD (0x00000001)") OR (TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Hidden" Details="DWORD (0x00000002)")

[Displaying Hidden Files Feature Disabled]
description = Detects modifications to the "Hidden" and "ShowSuperHidden" explorer registry values in order to disable showing of hidden files and system files. \
This technique is abused by several malware families to hide their files from normal users.
search = TargetObject IN ("*\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ShowSuperHidden", "*\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Hidden") Details="DWORD (0x00000000)"

[Registry Hide Function from User]
description = Detects registry modifications that hide internal tools or functions from the user (malware like Agent Tesla, Hermetic Wiper uses this technique)
search = (TargetObject IN ("*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\HideClock", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\HideSCAHealth", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\HideSCANetwork", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\HideSCAPower", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\HideSCAVolume") Details="DWORD (0x00000001)") OR (TargetObject IN ("*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ShowInfoTip", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ShowCompColor") Details="DWORD (0x00000000)")

[Hide Schedule Task Via Index Value Tamper]
description = Detects when the "index" value of a scheduled task is modified from the registry \
Which effectively hides it from any tooling such as "schtasks /query" (Read the referenced link for more information about the effects of this technique)
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\*" TargetObject="*Index*" Details="DWORD (0x00000000)"

[IE ZoneMap Setting Downgraded To MyComputer Zone For HTTP Protocols]
description = Detects changes to Internet Explorer's (IE / Windows Internet properties) ZoneMap configuration of the "HTTP" and "HTTPS" protocols to point to the "My Computer" zone. This allows downloaded files from the Internet to be granted the same level of trust as files stored locally.
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\ProtocolDefaults*" TargetObject IN ("*\\http", "*\\https") Details="*DWORD (0x00000000)*"

[Uncommon Extension In Keyboard Layout IME File Registry Value]
description = Detects usage of Windows Input Method Editor (IME) keyboard layout feature, which allows an attacker to load a DLL into the process after sending the WM_INPUTLANGCHANGEREQUEST message. \
Before doing this, the client needs to register the DLL in a special registry key that is assumed to implement this keyboard layout. This registry key should store a value named "Ime File" with a DLL path. \
IMEs are essential for languages that have more characters than can be represented on a standard keyboard, such as Chinese, Japanese, and Korean.
search = TargetObject="*\\Control\\Keyboard Layouts\\*" TargetObject="*Ime File*" NOT Details="*.ime"

[Suspicious Path In Keyboard Layout IME File Registry Value]
description = Detects usage of Windows Input Method Editor (IME) keyboard layout feature, which allows an attacker to load a DLL into the process after sending the WM_INPUTLANGCHANGEREQUEST message. \
Before doing this, the client needs to register the DLL in a special registry key that is assumed to implement this keyboard layout. This registry key should store a value named "Ime File" with a DLL path. \
IMEs are essential for languages that have more characters than can be represented on a standard keyboard, such as Chinese, Japanese, and Korean.
search = TargetObject="*\\Control\\Keyboard Layouts\\*" TargetObject="*Ime File*" Details IN ("*:\\Perflogs\\*", "*:\\Users\\Public\\*", "*:\\Windows\\Temp\\*", "*\\AppData\\Local\\Temp\\*", "*\\AppData\\Roaming\\*", "*\\Temporary Internet*") OR (Details="*:\\Users\\*" Details="*\\Favorites\\*") OR (Details="*:\\Users\\*" Details="*\\Favourites\\*") OR (Details="*:\\Users\\*" Details="*\\Contacts\\*")

[New Root or CA or AuthRoot Certificate to Store]
description = Detects the addition of new root, CA or AuthRoot certificates to the Windows registry
search = TargetObject IN ("*\\SOFTWARE\\Microsoft\\SystemCertificates\\Root\\Certificates\\*", "*\\SOFTWARE\\Policies\\Microsoft\\SystemCertificates\\Root\\Certificates\\*", "*\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\Root\\Certificates\\*", "*\\SOFTWARE\\Microsoft\\SystemCertificates\\CA\\Certificates\\*", "*\\SOFTWARE\\Policies\\Microsoft\\SystemCertificates\\CA\\Certificates\\*", "*\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\CA\\Certificates\\*", "*\\SOFTWARE\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*", "*\\SOFTWARE\\Policies\\Microsoft\\SystemCertificates\\AuthRoot\\Certificates\\*", "*\\SOFTWARE\\Microsoft\\EnterpriseCertificates\\AuthRoot\\Certificates\\*") TargetObject="*\\Blob" Details="Binary Data"

[Internet Explorer DisableFirstRunCustomize Enabled]
description = Detects changes to the Internet Explorer "DisableFirstRunCustomize" value, which prevents Internet Explorer from running the first run wizard the first time a user starts the browser after installing Internet Explorer or Windows.
search = TargetObject="*\\Microsoft\\Internet Explorer\\Main\\DisableFirstRunCustomize" Details IN ("DWORD (0x00000001)", "DWORD (0x00000002)") NOT (Image IN ("C:\\Windows\\explorer.exe", "C:\\Windows\\System32\\ie4uinit.exe"))

[Potential Ransomware Activity Using LegalNotice Message]
description = Detect changes to the "LegalNoticeCaption" or "LegalNoticeText" registry values where the message set contains keywords often used in ransomware ransom messages
search = TargetObject IN ("*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeCaption*", "*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\LegalNoticeText*") Details IN ("*encrypted*", "*Unlock-Password*", "*paying*")

[Lolbas OneDriveStandaloneUpdater.exe Proxy Download]
description = Detects setting a custom URL for OneDriveStandaloneUpdater.exe to download a file from the Internet without executing any \
anomalous executables with suspicious arguments. The downloaded file will be in C:\Users\redacted\AppData\Local\Microsoft\OneDrive\StandaloneUpdaterreSignInSettingsConfig.json
search = TargetObject="*\\SOFTWARE\\Microsoft\\OneDrive\\UpdateOfficeConfig\\UpdateRingSettingURLFromOC*"

[Lsass Full Dump Request Via DumpType Registry Settings]
description = Detects the setting of the "DumpType" registry value to "2" which stands for a "Full Dump". Technique such as LSASS Shtinkering requires this value to be "2" in order to dump LSASS.
search = TargetObject IN ("*\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\LocalDumps\\DumpType*", "*\\SOFTWARE\\Microsoft\\Windows\\Windows Error Reporting\\LocalDumps\\lsass.exe\\DumpType*") Details="DWORD (0x00000002)"

[RestrictedAdminMode Registry Value Tampering]
description = Detects changes to the "DisableRestrictedAdmin" registry value in order to disable or enable RestrictedAdmin mode. \
RestrictedAdmin mode prevents the transmission of reusable credentials to the remote system to which you connect using Remote Desktop. \
This prevents your credentials from being harvested during the initial connection process if the remote server has been compromise
search = TargetObject="*System\\CurrentControlSet\\Control\\Lsa\\DisableRestrictedAdmin"

[Blue Mockingbird - Registry]
description = Attempts to detect system changes made by Blue Mockingbird
search = TargetObject="*\\CurrentControlSet\\Services\\wercplsupport\\Parameters\\ServiceDll"

[Potential Persistence Via Netsh Helper DLL - Registry]
description = Detects changes to the Netsh registry key to add a new DLL value. This change might be an indication of a potential persistence attempt by adding a malicious Netsh helper
search = TargetObject="*\\SOFTWARE\\Microsoft\\NetSh*" Details="*.dll*"

[New Netsh Helper DLL Registered From A Suspicious Location]
description = Detects changes to the Netsh registry key to add a new DLL value that is located on a suspicious location. This change might be an indication of a potential persistence attempt by adding a malicious Netsh helper
search = TargetObject="*\\SOFTWARE\\Microsoft\\NetSh*" Details IN ("*:\\Perflogs\\*", "*:\\Users\\Public\\*", "*:\\Windows\\Temp\\*", "*\\AppData\\Local\\Temp\\*", "*\\Temporary Internet*") OR (Details="*:\\Users\\*" Details="*\\Favorites\\*") OR (Details="*:\\Users\\*" Details="*\\Favourites\\*") OR (Details="*:\\Users\\*" Details="*\\Contacts\\*") OR (Details="*:\\Users\\*" Details="*\\Pictures\\*")

[NET NGenAssemblyUsageLog Registry Key Tamper]
description = Detects changes to the NGenAssemblyUsageLog registry key. \
.NET Usage Log output location can be controlled by setting the NGenAssemblyUsageLog CLR configuration knob in the Registry or by configuring an environment variable (as described in the next section). \
By simplify specifying an arbitrary value (e.g. fake output location or junk data) for the expected value, a Usage Log file for the .NET execution context will not be created.
search = TargetObject="*SOFTWARE\\Microsoft\\.NETFramework\\NGenAssemblyUsageLog"

[New Application in AppCompat]
description = A General detection for a new application in AppCompat. This indicates an application executing for the first time on an endpoint.
search = TargetObject="*\\AppCompatFlags\\Compatibility Assistant\\Store\\*"

[Potential Credential Dumping Attempt Using New NetworkProvider - REG]
description = Detects when an attacker tries to add a new network provider in order to dump clear text credentials, similar to how the NPPSpy tool does it
search = TargetObject="*\\System\\CurrentControlSet\\Services\\*" TargetObject="*\\NetworkProvider*" NOT (TargetObject IN ("*\\System\\CurrentControlSet\\Services\\WebClient\\NetworkProvider*", "*\\System\\CurrentControlSet\\Services\\LanmanWorkstation\\NetworkProvider*", "*\\System\\CurrentControlSet\\Services\\RDPNP\\NetworkProvider*") OR Image="C:\\Windows\\System32\\poqexec.exe")

[New ODBC Driver Registered]
description = Detects the registration of a new ODBC driver.
search = TargetObject="*\\SOFTWARE\\ODBC\\ODBCINST.INI\\*" TargetObject="*\\Driver" NOT (TargetObject="*\\SQL Server\\*" Details="%WINDIR%\\System32\\SQLSRV32.dll") NOT ((TargetObject="*\\Microsoft Access *" Details="C:\\Progra*" Details="*\\ACEODBC.DLL") OR (TargetObject="*\\Microsoft Excel Driver*" Details="C:\\Progra*" Details="*\\ACEODBC.DLL"))

[Potentially Suspicious ODBC Driver Registered]
description = Detects the registration of a new ODBC driver where the driver is located in a potentially suspicious location
search = TargetObject="*\\SOFTWARE\\ODBC\\ODBCINST.INI\\*" TargetObject IN ("*\\Driver", "*\\Setup") Details IN ("*:\\PerfLogs\\*", "*:\\ProgramData\\*", "*:\\Temp\\*", "*:\\Users\\Public\\*", "*:\\Windows\\Registration\\CRMLog*", "*:\\Windows\\System32\\com\\dmp\\*", "*:\\Windows\\System32\\FxsTmp\\*", "*:\\Windows\\System32\\Microsoft\\Crypto\\RSA\\MachineKeys\\*", "*:\\Windows\\System32\\spool\\drivers\\color\\*", "*:\\Windows\\System32\\spool\\PRINTERS\\*", "*:\\Windows\\System32\\spool\\SERVERS\\*", "*:\\Windows\\System32\\Tasks_Migrated\\*", "*:\\Windows\\System32\\Tasks\\Microsoft\\Windows\\SyncCenter\\*", "*:\\Windows\\SysWOW64\\com\\dmp\\*", "*:\\Windows\\SysWOW64\\FxsTmp\\*", "*:\\Windows\\SysWOW64\\Tasks\\Microsoft\\Windows\\PLA\\System\\*", "*:\\Windows\\SysWOW64\\Tasks\\Microsoft\\Windows\\SyncCenter\\*", "*:\\Windows\\Tasks\\*", "*:\\Windows\\Temp\\*", "*:\\Windows\\Tracing\\*", "*\\AppData\\Local\\Temp\\*", "*\\AppData\\Roaming\\*")

[Trust Access Disable For VBApplications]
description = Detects registry changes to Microsoft Office "AccessVBOM" to a value of "1" which disables trust access for VBA on the victim machine and lets attackers execute malicious macros without any Microsoft Office warnings.
search = TargetObject="*\\Security\\AccessVBOM" Details="DWORD (0x00000001)"

[Microsoft Office Protected View Disabled]
description = Detects changes to Microsoft Office protected view registry keys with which the attacker disables this feature.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Office\\*" TargetObject="*\\Security\\ProtectedView\\*" (Details="DWORD (0x00000001)" TargetObject IN ("*\\DisableAttachementsInPV", "*\\DisableInternetFilesInPV", "*\\DisableIntranetCheck", "*\\DisableUnsafeLocationsInPV")) OR (Details="DWORD (0x00000000)" TargetObject IN ("*\\enabledatabasefileprotectedview", "*\\enableforeigntextfileprotectedview"))

[Enable Microsoft Dynamic Data Exchange]
description = Enable Dynamic Data Exchange protocol (DDE) in all supported editions of Microsoft Word or Excel.
search = (TargetObject="*\\Word\\Security\\AllowDDE" Details IN ("DWORD (0x00000001)", "DWORD (0x00000002)")) OR (TargetObject IN ("*\\Excel\\Security\\DisableDDEServerLaunch", "*\\Excel\\Security\\DisableDDEServerLookup") Details="DWORD (0x00000000)")

[Potential Persistence Via Outlook LoadMacroProviderOnBoot Setting]
description = Detects the modification of Outlook setting "LoadMacroProviderOnBoot" which if enabled allows the automatic loading of any configured VBA project/module
search = TargetObject="*\\Outlook\\LoadMacroProviderOnBoot" Details="*0x00000001*"

[Outlook Macro Execution Without Warning Setting Enabled]
description = Detects the modification of Outlook security setting to allow unprompted execution of macros.
search = TargetObject="*\\Outlook\\Security\\Level" Details="*0x00000001*"

[Outlook EnableUnsafeClientMailRules Setting Enabled - Registry]
description = Detects an attacker trying to enable the outlook security setting "EnableUnsafeClientMailRules" which allows outlook to run applications or execute macros
search = TargetObject="*\\Outlook\\Security\\EnableUnsafeClientMailRules" Details="DWORD (0x00000001)"

[Outlook Security Settings Updated - Registry]
description = Detects changes to the registry values related to outlook security settings
search = TargetObject="*\\SOFTWARE\\Microsoft\\Office\\*" TargetObject="*\\Outlook\\Security\\*"

[Uncommon Microsoft Office Trusted Location Added]
description = Detects changes to registry keys related to "Trusted Location" of Microsoft Office where the path is set to something uncommon. Attackers might add additional trusted locations to avoid macro security restrictions.
search = TargetObject="*Security\\Trusted Locations\\Location*" TargetObject="*\\Path" NOT ((Image="*:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*" Image="*\\OfficeClickToRun.exe") OR Image IN ("*:\\Program Files\\Microsoft Office\\*", "*:\\Program Files (x86)\\Microsoft Office\\*")) NOT (Details IN ("*%APPDATA%\\Microsoft\\Templates*", "*%%APPDATA%%\\Microsoft\\Templates*", "*%APPDATA%\\Microsoft\\Word\\Startup*", "*%%APPDATA%%\\Microsoft\\Word\\Startup*", "*:\\Program Files (x86)\\Microsoft Office\\root\\Templates\\*", "*:\\Program Files\\Microsoft Office (x86)\\Templates*", "*:\\Program Files\\Microsoft Office\\root\\Templates\\*", "*:\\Program Files\\Microsoft Office\\Templates\\*"))

[Macro Enabled In A Potentially Suspicious Document]
description = Detects registry changes to Office trust records where the path is located in a potentially suspicious location
search = TargetObject="*\\Security\\Trusted Documents\\TrustRecords*" TargetObject IN ("*/AppData/Local/Microsoft/Windows/INetCache/*", "*/AppData/Local/Temp/*", "*/PerfLogs/*", "*C:/Users/Public/*", "*file:///D:/*", "*file:///E:/*")

[Office Macros Warning Disabled]
description = Detects registry changes to Microsoft Office "VBAWarning" to a value of "1" which enables the execution of all macros, whether signed or unsigned.
search = TargetObject="*\\Security\\VBAWarnings" Details="DWORD (0x00000001)"

[MaxMpxCt Registry Value Changed]
description = Detects changes to the "MaxMpxCt" registry value. \
MaxMpxCt specifies the maximum outstanding network requests for the server per client, which is used when negotiating a Server Message Block (SMB) connection with a client. Note if the value is set beyond 125 older Windows 9x clients will fail to negotiate. \
Ransomware threat actors and operators (specifically BlackCat) were seen increasing this value in order to handle a higher volume of traffic.
search = TargetObject="*\\Services\\LanmanServer\\Parameters\\MaxMpxCt"

[Potential Persistence Using DebugPath]
description = Detects potential persistence using Appx DebugPath
search = (TargetObject="*Classes\\ActivatableClasses\\Package\\Microsoft.*" TargetObject="*\\DebugPath") OR (TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\PackagedAppXDebug\\Microsoft.*" TargetObject="*\\(Default)")

[Potential Persistence Via AppCompat RegisterAppRestart Layer]
description = Detects the setting of the REGISTERAPPRESTART compatibility layer on an application. \
This compatibility layer allows an application to register for restart using the "RegisterApplicationRestart" API. \
This can be potentially abused as a persistence mechanism.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Layers\\*" Details="*REGISTERAPPRESTART*"

[Potential Persistence Via App Paths Default Property]
description = Detects changes to the "Default" property for keys located in the \Software\Microsoft\Windows\CurrentVersion\App Paths\ registry. Which might be used as a method of persistence \
The entries found under App Paths are used primarily for the following purposes. \
First, to map an application's executable file name to that file's fully qualified path. \
Second, to prepend information to the PATH environment variable on a per-application, per-process basis.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths*" TargetObject IN ("*(Default)", "*Path") Details IN ("*\\Users\\Public*", "*\\AppData\\Local\\Temp\\*", "*\\Windows\\Temp\\*", "*\\Desktop\\*", "*\\Downloads\\*", "*%temp%*", "*%tmp%*", "*iex*", "*Invoke-*", "*rundll32*", "*regsvr32*", "*mshta*", "*cscript*", "*wscript*", "*.bat*", "*.hta*", "*.dll*", "*.ps1*")

[Potential Persistence Via AutodialDLL]
description = Detects change the the "AutodialDLL" key which could be used as a persistence method to load custom DLL via the "ws2_32" library
search = TargetObject="*\\Services\\WinSock2\\Parameters\\AutodialDLL*"

[Potential Persistence Via CHM Helper DLL]
description = Detects when an attacker modifies the registry key "HtmlHelp Author" to achieve persistence
search = TargetObject IN ("*\\Software\\Microsoft\\HtmlHelp Author\\Location*", "*\\Software\\WOW6432Node\\Microsoft\\HtmlHelp Author\\Location*")

[Potential PSFactoryBuffer COM Hijacking]
description = Detects changes to the PSFactory COM InProcServer32 registry. This technique was used by RomCom to create persistence storing a malicious DLL.
search = TargetObject="*\\CLSID\\{c90250f3-4d7d-4991-9b69-a5c5bc1c2ae6}\\InProcServer32\\(Default)" NOT (Details IN ("%windir%\\System32\\ActXPrxy.dll", "C:\\Windows\\System32\\ActXPrxy.dll"))

[Potential Persistence Via COM Hijacking From Suspicious Locations]
description = Detects potential COM object hijacking where the "Server" (In/Out) is pointing to a suspicious or unsuale location
search = TargetObject="*\\CLSID\\*" TargetObject IN ("*\\InprocServer32\\(Default)", "*\\LocalServer32\\(Default)") Details IN ("*\\AppData\\Local\\Temp\\*", "*\\Desktop\\*", "*\\Downloads\\*", "*\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\*", "*\\System32\\spool\\drivers\\color\\*", "*\\Users\\Public\\*", "*\\Windows\\Temp\\*", "*%appdata%*", "*%temp%*", "*%tmp%*")

[Potential Persistence Via Custom Protocol Handler]
description = Detects potential persistence activity via the registering of a new custom protocole handlers. While legitimate applications register protocole handlers often times during installation. And attacker can abuse this by setting a custom handler to be used as a persistence mechanism.
search = TargetObject="HKCR\\*" Details="URL:*" NOT (Details="URL:ms-*" OR Image IN ("C:\\Program Files (x86)*", "C:\\Program Files\\*", "C:\\Windows\\System32\\*", "C:\\Windows\\SysWOW64\\*"))

[Potential Persistence Via Event Viewer Events.asp]
description = Detects potential registry persistence technique using the Event Viewer "Events.asp" technique
search = TargetObject IN ("*\\Microsoft\\Windows NT\\CurrentVersion\\Event Viewer\\MicrosoftRedirectionProgram*", "*\\Microsoft\\Windows NT\\CurrentVersion\\Event Viewer\\MicrosoftRedirectionURL*") NOT ((Image="*C:\\WINDOWS\\system32\\svchost.exe" TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\Event Viewer\\MicrosoftRedirectionProgram" Details="%%SystemRoot%%\\PCHealth\\HelpCtr\\Binaries\\HelpCtr.exe") OR (Image="*C:\\WINDOWS\\system32\\svchost.exe" TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\Event Viewer\\MicrosoftRedirectionProgramCommandLineParameters" Details="-url hcp://services/centers/support*topic=%%s") OR Details="http://go.microsoft.com/fwlink/events.asp" OR Details="(Empty)")

[Potential Persistence Via GlobalFlags]
description = Detects registry persistence technique using the GlobalFlags and SilentProcessExit keys
search = (TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\*" TargetObject="*\\Image File Execution Options\\*" TargetObject="*\\GlobalFlag*") OR (TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\*" TargetObject="*\\SilentProcessExit\\*" TargetObject IN ("*\\ReportingMode*", "*\\MonitorProcess*"))

[Modification of IE Registry Settings]
description = Detects modification of the registry settings used for Internet Explorer and other Windows components that use these settings. An attacker can abuse this registry key to add a domain to the trusted sites Zone or insert javascript for persistence
search = TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings*" NOT (Details="DWORD*" OR Details IN ("Cookie:", "Visited:", "(Empty)") OR TargetObject IN ("*\\Cache*", "*\\ZoneMap*", "*\\WpadDecision*") OR Details="Binary Data" OR TargetObject="*\\Accepted Documents\\*")

[Register New IFiltre For Persistence]
description = Detects when an attacker registers a new IFilter for an extension. Microsoft Windows Search uses filters to extract the content of items for inclusion in a full-text index. \
You can extend Windows Search to index new or proprietary file types by writing filters to extract the content, and property handlers to extract the properties of files.
search = (TargetObject="*\\SOFTWARE\\Classes\\.*" TargetObject="*\\PersistentHandler*") OR (TargetObject="*\\SOFTWARE\\Classes\\CLSID*" TargetObject="*\\PersistentAddinsRegistered\\{89BCB740-6119-101A-BCB7-00DD010655AF}*") NOT (TargetObject IN ("*\\CLSID\\{4F46F75F-199F-4C63-8B7D-86D48FE7970C}\\*", "*\\CLSID\\{4887767F-7ADC-4983-B576-88FB643D6F79}\\*", "*\\CLSID\\{D3B41FA1-01E3-49AF-AA25-1D0D824275AE}\\*", "*\\CLSID\\{72773E1A-B711-4d8d-81FA-B9A43B0650DD}\\*", "*\\CLSID\\{098f2470-bae0-11cd-b579-08002b30bfeb}\\*", "*\\CLSID\\{1AA9BF05-9A97-48c1-BA28-D9DCE795E93C}\\*", "*\\CLSID\\{2e2294a9-50d7-4fe7-a09f-e6492e185884}\\*", "*\\CLSID\\{34CEAC8D-CBC0-4f77-B7B1-8A60CB6DA0F7}\\*", "*\\CLSID\\{3B224B11-9363-407e-850F-C9E1FFACD8FB}\\*", "*\\CLSID\\{3DDEB7A4-8ABF-4D82-B9EE-E1F4552E95BE}\\*", "*\\CLSID\\{5645C8C1-E277-11CF-8FDA-00AA00A14F93}\\*", "*\\CLSID\\{5645C8C4-E277-11CF-8FDA-00AA00A14F93}\\*", "*\\CLSID\\{58A9EBF6-5755-4554-A67E-A2467AD1447B}\\*", "*\\CLSID\\{5e941d80-bf96-11cd-b579-08002b30bfeb}\\*", "*\\CLSID\\{698A4FFC-63A3-4E70-8F00-376AD29363FB}\\*", "*\\CLSID\\{7E9D8D44-6926-426F-AA2B-217A819A5CCE}\\*", "*\\CLSID\\{8CD34779-9F10-4f9b-ADFB-B3FAEABDAB5A}\\*", "*\\CLSID\\{9694E38A-E081-46ac-99A0-8743C909ACB6}\\*", "*\\CLSID\\{98de59a0-d175-11cd-a7bd-00006b827d94}\\*", "*\\CLSID\\{AA10385A-F5AA-4EFF-B3DF-71B701E25E18}\\*", "*\\CLSID\\{B4132098-7A03-423D-9463-163CB07C151F}\\*", "*\\CLSID\\{d044309b-5da6-4633-b085-4ed02522e5a5}\\*", "*\\CLSID\\{D169C14A-5148-4322-92C8-754FC9D018D8}\\*", "*\\CLSID\\{DD75716E-B42E-4978-BB60-1497B92E30C4}\\*", "*\\CLSID\\{E2F83EED-62DE-4A9F-9CD0-A1D40DCD13B6}\\*", "*\\CLSID\\{E772CEB3-E203-4828-ADF1-765713D981B8}\\*", "*\\CLSID\\{eec97550-47a9-11cf-b952-00aa0051fe20}*", "*\\CLSID\\{FB10BD80-A331-4e9e-9EB7-00279903AD99}\\*") OR Image IN ("C:\\Windows\\System32\\*", "C:\\Program Files (x86)\\*", "C:\\Program Files\\*"))

[Potential Persistence Via LSA Extensions]
description = Detects when an attacker modifies the "REG_MULTI_SZ" value named "Extensions" to include a custom DLL to achieve persistence via lsass. \
The "Extensions" list contains filenames of DLLs being automatically loaded by lsass.exe. Each DLL has its InitializeLsaExtension() method called after loading.
search = TargetObject="*\\SYSTEM\\CurrentControlSet\\Control\\LsaExtensionConfig\\LsaSrv\\Extensions*"

[Potential Persistence Via Mpnotify]
description = Detects when an attacker register a new SIP provider for persistence and defense evasion
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\mpnotify*"

[Potential Persistence Via MyComputer Registry Keys]
description = Detects modification to the "Default" value of the "MyComputer" key and subkeys to point to a custom binary that will be launched whenever the associated action is executed (see reference section for example)
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MyComputer*" TargetObject="*(Default)"

[Potential Persistence Via DLLPathOverride]
description = Detects when an attacker adds a new "DLLPathOverride" value to the "Natural Language" key in order to achieve persistence which will get invoked by "SearchIndexer.exe" process
search = TargetObject="*\\SYSTEM\\CurrentControlSet\\Control\\ContentIndex\\Language\\*" TargetObject IN ("*\\StemmerDLLPathOverride*", "*\\WBDLLPathOverride*", "*\\StemmerClass*", "*\\WBreakerClass*")

[Potential Persistence Via Visual Studio Tools for Office]
description = Detects persistence via Visual Studio Tools for Office (VSTO) add-ins in Office applications.
search = TargetObject IN ("*\\Software\\Microsoft\\Office\\Outlook\\Addins\\*", "*\\Software\\Microsoft\\Office\\Word\\Addins\\*", "*\\Software\\Microsoft\\Office\\Excel\\Addins\\*", "*\\Software\\Microsoft\\Office\\Powerpoint\\Addins\\*", "*\\Software\\Microsoft\\VSTO\\Security\\Inclusion\\*") NOT (Image IN ("*\\msiexec.exe", "*\\regsvr32.exe") OR Image IN ("*\\excel.exe", "*\\integrator.exe", "*\\OfficeClickToRun.exe", "*\\winword.exe", "*\\visio.exe") OR Image="*\\Teams.exe" OR (Image="C:\\Program Files\\AVG\\Antivirus\\RegSvr.exe" TargetObject="*\\Microsoft\\Office\\Outlook\\Addins\\Antivirus.AsOutExt\\*"))

[Potential Persistence Via Outlook Home Page]
description = Detects potential persistence activity via outlook home pages.
search = TargetObject IN ("*\\Software\\Microsoft\\Office\\*", "*\\Outlook\\WebView\\*") TargetObject="*\\URL" TargetObject IN ("*\\Calendar\\*", "*\\Inbox\\*") \
| table Details

[Potential Persistence Via Outlook Today Pages]
description = Detects potential persistence activity via outlook today pages. An attacker can set a custom page to execute arbitrary code and link to it via the registry key "UserDefinedUrl".
search = TargetObject="*Software\\Microsoft\\Office\\*" TargetObject="*\\Outlook\\Today\\*" (TargetObject="*Stamp" Details="DWORD (0x00000001)") OR TargetObject="*UserDefinedUrl" NOT (Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*") Image="*\\OfficeClickToRun.exe") \
| table Details

[Potential WerFault ReflectDebugger Registry Value Abuse]
description = Detects potential WerFault "ReflectDebugger" registry value abuse for persistence.
search = EventType="SetValue" TargetObject="*\\Microsoft\\Windows\\Windows Error Reporting\\Hangs\\ReflectDebugger"

[Potential Persistence Via Scrobj.dll COM Hijacking]
description = Detect use of scrobj.dll as this DLL looks for the ScriptletURL key to get the location of the script to execute
search = TargetObject="*InprocServer32\\(Default)" Details="C:\\WINDOWS\\system32\\scrobj.dll"

[Potential Persistence Via COM Search Order Hijacking]
description = Detects potential COM object hijacking leveraging the COM Search Order
search = TargetObject="*\\CLSID\\*" TargetObject="*\\InprocServer32\\(Default)" NOT (Details IN ("*%%systemroot%%\\system32\\*", "*%%systemroot%%\\SysWow64\\*") OR Details IN ("*\\AppData\\Local\\Microsoft\\OneDrive\\*", "*\\FileCoAuthLib64.dll*", "*\\FileSyncShell64.dll*", "*\\FileSyncApi64.dll*") OR Image="*:\\WINDOWS\\system32\\SecurityHealthService.exe" OR (Details="*\\AppData\\Local\\Microsoft\\TeamsMeetingAddin\\*" Details="*\\Microsoft.Teams.AddinLoader.dll*") OR (Details="*\\AppData\\Roaming\\Dropbox\\*" Details="*\\DropboxExt64.*.dll*") OR Details="*TmopIEPlg.dll" OR Image IN ("*:\\WINDOWS\\system32\\wuauclt.exe", "*:\\WINDOWS\\system32\\svchost.exe") OR (Image IN ("*:\\ProgramData\\Microsoft\\Windows Defender\\Platform\\*", "*:\\Program Files\\Windows Defender\\*") Image="*\\MsMpEng.exe") OR Details="*\\FileRepository\\nvmdi.inf*" OR Image="*\\MicrosoftEdgeUpdateComRegisterShell64.exe" OR Image="*:\\WINDOWS\\SYSTEM32\\dxdiag.exe" OR Details IN ("*:\\Windows\\pyshellext.amd64.dll", "*:\\Windows\\pyshellext.dll") OR Details IN ("*:\\Windows\\system32\\dnssdX.dll", "*:\\Windows\\SysWOW64\\dnssdX.dll") OR Details="*:\\Windows\\system32\\spool\\drivers\\x64\\3\\PrintConfig.dll" OR Details IN ("*:\\Program Files\\*", "*:\\Program Files (x86)\\*") OR Details="*:\\ProgramData\\Microsoft\\*" OR Details="*:\\WINDOWS\\system32\\GamingServicesProxy.dll*" OR (Image="*:\\Windows\\System32\\poqexec.exe" Details="*:\\Windows\\System32\\Autopilot.dll*") OR (Image="*:\\Windows\\system32\\SecurityHealthService.exe" Details="*:\\Windows\\System32\\SecurityHealth*") OR (Image IN ("*:\\Windows\\System32\\poqexec.exe", "*:\\Windows\\System32\\regsvr32.exe") TargetObject="*\\InProcServer32\\(Default)"))

[Potential Persistence Via Shim Database Modification]
description = Adversaries may establish persistence and/or elevate privileges by executing malicious content triggered by application shims. \
The Microsoft Windows Application Compatibility Infrastructure/Framework (Application Shim) was created to allow for backward compatibility of software as the operating system codebase changes over time
search = TargetObject IN ("*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB\\*", "*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\*") NOT Details=""

[Suspicious Shim Database Patching Activity]
description = Detects installation of new shim databases that try to patch sections of known processes for potential process injection or persistence.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\*" TargetObject IN ("*\\csrss.exe", "*\\dllhost.exe", "*\\explorer.exe", "*\\RuntimeBroker.exe", "*\\services.exe", "*\\sihost.exe", "*\\svchost.exe", "*\\taskhostw.exe", "*\\winlogon.exe", "*\\WmiPrvSe.exe")

[Potential Persistence Via Shim Database In Uncommon Location]
description = Detects the installation of a new shim database where the file is located in a non-default location
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\InstalledSDB\\*" TargetObject="*\\DatabasePath*" NOT Details="*:\\Windows\\AppPatch\\Custom*"

[Potential Persistence Via TypedPaths]
description = Detects modification addition to the 'TypedPaths' key in the user or admin registry from a non standard application. Which might indicate persistence attempt
search = TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPaths\\*" NOT (Image IN ("C:\\Windows\\explorer.exe", "C:\\Windows\\SysWOW64\\explorer.exe"))

[Potential Persistence Via Excel Add-in - Registry]
description = Detect potential persistence via the creation of an excel add-in (XLL) file to make it run automatically when Excel is started.
search = TargetObject="*Software\\Microsoft\\Office\\*" TargetObject="*\\Excel\\Options" Details="/R *" Details="*.xll"

[Potential Attachment Manager Settings Associations Tamper]
description = Detects tampering with attachment manager settings policies associations to lower the default file type risks (See reference for more information)
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Associations\\*" (TargetObject="*\\DefaultFileTypeRisk" Details="DWORD (0x00006152)") OR (TargetObject="*\\LowRiskFileTypes" Details IN ("*.zip;*", "*.rar;*", "*.exe;*", "*.bat;*", "*.com;*", "*.cmd;*", "*.reg;*", "*.msi;*", "*.htm;*", "*.html;*"))

[Potential Attachment Manager Settings Attachments Tamper]
description = Detects tampering with attachment manager settings policies attachments (See reference for more information)
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Attachments\\*" (TargetObject="*\\HideZoneInfoOnProperties" Details="DWORD (0x00000001)") OR (TargetObject="*\\SaveZoneInformation" Details="DWORD (0x00000002)") OR (TargetObject="*\\ScanWithAntiVirus" Details="DWORD (0x00000001)")

[PowerShell as a Service in Registry]
description = Detects that a powershell code is written to the registry as a service.
search = TargetObject="*\\Services\\*" TargetObject="*\\ImagePath" Details IN ("*powershell*", "*pwsh*")

[PowerShell Script Execution Policy Enabled]
description = Detects the enabling of the PowerShell script execution policy. Once enabled, this policy allows scripts to be executed.
search = TargetObject="*\\Policies\\Microsoft\\Windows\\PowerShell\\EnableScripts" Details="DWORD (0x00000001)"

[Potential PowerShell Execution Policy Tampering]
description = Detects changes to the PowerShell execution policy in order to bypass signing requirements for script execution
search = TargetObject IN ("*\\ShellIds\\Microsoft.PowerShell\\ExecutionPolicy", "*\\Policies\\Microsoft\\Windows\\PowerShell\\ExecutionPolicy") Details IN ("*Bypass*", "*Unrestricted*") NOT (Image IN ("*:\\Windows\\System32\\*", "*:\\Windows\\SysWOW64\\*"))

[Suspicious Powershell In Registry Run Keys]
description = Detects potential PowerShell commands or code within registry run keys
search = TargetObject="*\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*" Details IN ("*powershell*", "*pwsh *", "*FromBase64String*", "*.DownloadFile(*", "*.DownloadString(*", "* -w hidden *", "* -w 1 *", "*-windowstyle hidden*", "*-window hidden*", "* -nop *", "* -encodedcommand *", "*-ExecutionPolicy Bypass*", "*Invoke-Expression*", "*IEX (*", "*Invoke-Command*", "*ICM -*", "*Invoke-WebRequest*", "*IWR *", "* -noni *", "* -noninteractive *")

[PowerShell Logging Disabled Via Registry Key Tampering]
description = Detects changes to the registry for the currently logged-in user. In order to disable PowerShell module logging, script block logging or transcription and script execution logging
search = TargetObject IN ("*\\Microsoft\\Windows\\PowerShell\\*", "*\\Microsoft\\PowerShellCore\\*") TargetObject IN ("*\\ModuleLogging\\EnableModuleLogging", "*\\ScriptBlockLogging\\EnableScriptBlockLogging", "*\\ScriptBlockLogging\\EnableScriptBlockInvocationLogging", "*\\Transcription\\EnableTranscripting", "*\\Transcription\\EnableInvocationHeader", "*\\EnableScripts") Details="DWORD (0x00000000)"

[Potential Provisioning Registry Key Abuse For Binary Proxy Execution - REG]
description = Detects potential abuse of the provisioning registry key for indirect command execution through "Provlaunch.exe".
search = TargetObject="*\\SOFTWARE\\Microsoft\\Provisioning\\Commands\\*"

[Usage of Renamed Sysinternals Tools - RegistrySet]
description = Detects non-sysinternals tools setting the "accepteula" key which normally is set on sysinternals tool execution
search = TargetObject IN ("*\\PsExec*", "*\\ProcDump*", "*\\Handle*", "*\\LiveKd*", "*\\Process Explorer*", "*\\PsLoglist*", "*\\PsPasswd*", "*\\Active Directory Explorer*") TargetObject="*\\EulaAccepted" NOT (Image IN ("*\\PsExec.exe", "*\\PsExec64.exe", "*\\procdump.exe", "*\\procdump64.exe", "*\\handle.exe", "*\\handle64.exe", "*\\livekd.exe", "*\\livekd64.exe", "*\\procexp.exe", "*\\procexp64.exe", "*\\psloglist.exe", "*\\psloglist64.exe", "*\\pspasswd.exe", "*\\pspasswd64.exe", "*\\ADExplorer.exe", "*\\ADExplorer64.exe")) NOT Image!=*

[ETW Logging Disabled For rpcrt4.dll]
description = Detects changes to the "ExtErrorInformation" key in order to disable ETW logging for rpcrt4.dll
search = TargetObject="*\\Microsoft\\Windows NT\\Rpc\\ExtErrorInformation" Details IN ("DWORD (0x00000000)", "DWORD (0x00000002)")

[ScreenSaver Registry Key Set]
description = Detects registry key established after masqueraded .scr file execution using Rundll32 through desk.cpl
search = Image="*\\rundll32.exe" TargetObject="*\\Control Panel\\Desktop\\SCRNSAVE.EXE*" Details="*.scr" NOT (Details IN ("*C:\\Windows\\System32\\*", "*C:\\Windows\\SysWOW64\\*"))

[Potential SentinelOne Shell Context Menu Scan Command Tampering]
description = Detects potentially suspicious changes to the SentinelOne context menu scan command by a process other than SentinelOne.
search = TargetObject="*\\shell\\SentinelOneScan\\command\\*" NOT ((Details IN ("C:\\Program Files\\SentinelOne\\Sentinel Agent*", "C:\\Program Files (x86)\\SentinelOne\\Sentinel Agent*") Details="*\\SentinelScanFromContextMenu.exe*") OR Image IN ("*C:\\Program Files\\SentinelOne\\", "*C:\\Program Files (x86)\\SentinelOne\\"))

[ServiceDll Hijack]
description = Detects changes to the "ServiceDLL" value related to a service in the registry. \
This is often used as a method of persistence.
search = TargetObject="*\\System\\*" TargetObject="*ControlSet*" TargetObject="*\\Services\\*" TargetObject="*\\Parameters\\ServiceDll" NOT (Details="C:\\Windows\\system32\\spool\\drivers\\x64\\3\\PrintConfig.dll" OR (Image="C:\\Windows\\system32\\lsass.exe" TargetObject="*\\Services\\NTDS\\Parameters\\ServiceDll" Details="%%systemroot%%\\system32\\ntdsa.dll") OR Image="C:\\Windows\\System32\\poqexec.exe") NOT (Image="*\\regsvr32.exe" Details="C:\\Windows\\System32\\STAgent.dll")

[ETW Logging Disabled For SCM]
description = Detects changes to the "TracingDisabled" key in order to disable ETW logging for services.exe (SCM)
search = TargetObject="*Software\\Microsoft\\Windows NT\\CurrentVersion\\Tracing\\SCM\\Regular\\TracingDisabled" Details="DWORD (0x00000001)"

[Registry Explorer Policy Modification]
description = Detects registry modifications that disable internal tools or functions in explorer (malware like Agent Tesla uses this technique)
search = TargetObject IN ("*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoLogOff", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoDesktop", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoRun", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoFind", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoControlPanel", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoFileMenu", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoClose", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoSetTaskbar", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoPropertiesMyDocuments", "*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\NoTrayContextMenu") Details="DWORD (0x00000001)"

[Persistence Via New SIP Provider]
description = Detects when an attacker register a new SIP provider for persistence and defense evasion
search = TargetObject IN ("*\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\*", "*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType*", "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\*", "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType*") TargetObject IN ("*\\Dll*", "*\\$DLL*") NOT (Details IN ("WINTRUST.DLL", "mso.dll") OR (Image="C:\\Windows\\System32\\poqexec.exe" TargetObject="*\\CryptSIPDll*" Details="C:\\Windows\\System32\\PsfSip.dll"))

[Tamper With Sophos AV Registry Keys]
description = Detects tamper attempts to sophos av functionality via registry key modification
search = TargetObject IN ("*\\Sophos Endpoint Defense\\TamperProtection\\Config\\SAVEnabled*", "*\\Sophos Endpoint Defense\\TamperProtection\\Config\\SEDEnabled*", "*\\Sophos\\SAVService\\TamperProtection\\Enabled*") Details="DWORD (0x00000000)"

[Hiding User Account Via SpecialAccounts Registry Key]
description = Detects modifications to the registry key "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" where the value is set to "0" in order to hide user account from being listed on the logon screen.
search = EventType="SetValue" TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList*" Details="DWORD (0x00000000)"

[Activate Suppression of Windows Security Center Notifications]
description = Detect set Notification_Suppress to 1 to disable the Windows security center notification
search = TargetObject="*SOFTWARE\\Policies\\Microsoft\\Windows Defender\\UX Configuration\\Notification_Suppress" Details="DWORD (0x00000001)"

[Suspicious Environment Variable Has Been Registered]
description = Detects the creation of user-specific or system-wide environment variables via the registry. Which contains suspicious commands and strings
search = TargetObject="*\\Environment\\*" Details IN ("powershell", "pwsh") OR Details IN ("*\\AppData\\Local\\Temp\\*", "*C:\\Users\\Public\\*", "*TVqQAAMAAAAEAAAA*", "*TVpQAAIAAAAEAA8A*", "*TVqAAAEAAAAEABAA*", "*TVoAAAAAAAAAAAAA*", "*TVpTAQEAAAAEAAAA*", "*SW52b2tlL*", "*ludm9rZS*", "*JbnZva2Ut*", "*SQBuAHYAbwBrAGUALQ*", "*kAbgB2AG8AawBlAC0A*", "*JAG4AdgBvAGsAZQAtA*") OR Details IN ("SUVY*", "SQBFAF*", "SQBuAH*", "cwBhA*", "aWV4*", "aQBlA*", "R2V0*", "dmFy*", "dgBhA*", "dXNpbm*", "H4sIA*", "Y21k*", "cABhAH*", "Qzpc*", "Yzpc*")

[Suspicious Keyboard Layout Load]
description = Detects the keyboard preload installation with a suspicious keyboard layout, e.g. Chinese, Iranian or Vietnamese layout load in user session on systems maintained by US staff only
search = TargetObject IN ("*\\Keyboard Layout\\Preload\\*", "*\\Keyboard Layout\\Substitutes\\*") Details IN ("*00000429*", "*00050429*", "*0000042a*")

[Potential PendingFileRenameOperations Tamper]
description = Detect changes to the "PendingFileRenameOperations" registry key from uncommon or suspicious images lcoations to stage currently used files for rename after reboot.
search = EventType="SetValue" TargetObject="*\\CurrentControlSet\\Control\\Session Manager\\PendingFileRenameOperations*" Image IN ("*\\AppData\\Local\\Temp\\*", "*\\Users\\Public\\*") OR Image IN ("*\\reg.exe", "*\\regedit.exe")

[Suspicious Printer Driver Empty Manufacturer]
description = Detects a suspicious printer driver installation with an empty Manufacturer value
search = TargetObject="*\\Control\\Print\\Environments\\Windows x64\\Drivers*" TargetObject="*\\Manufacturer*" Details="(Empty)" NOT (TargetObject="*\\CutePDF Writer v4.0\\*" OR TargetObject IN ("*\\VNC Printer (PS)\\*", "*\\VNC Printer (UD)\\*") OR TargetObject="*\\Version-3\\PDF24\\*")

[Registry Persistence via Explorer Run Key]
description = Detects a possible persistence mechanism using RUN key for Windows Explorer and pointing to a suspicious folder
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer\\Run" Details IN ("*:\\$Recycle.bin\\*", "*:\\ProgramData\\*", "*:\\Temp\\*", "*:\\Users\\Default\\*", "*:\\Users\\Public\\*", "*:\\Windows\\Temp\\*", "*\\AppData\\Local\\Temp\\*")

[New RUN Key Pointing to Suspicious Folder]
description = Detects suspicious new RUN key element pointing to an executable in a suspicious folder
search = TargetObject IN ("*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\*", "*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce\\*") Details IN ("*:\\$Recycle.bin\\*", "*:\\Temp\\*", "*:\\Users\\Default\\*", "*:\\Users\\Desktop\\*", "*:\\Users\\Public\\*", "*:\\Windows\\Temp\\*", "*\\AppData\\Local\\Temp\\*", "*%temp%\\*", "*%tmp%\\*") OR Details IN ("%Public%\\*", "wscript*", "cscript*") NOT (Image="C:\\Windows\\SoftwareDistribution\\Download\\*" Details="*rundll32.exe C:\\WINDOWS\\system32\\advpack.dll,DelNodeRunDLL32*" Details="*C:\\Windows\\Temp\\*")

[Suspicious Service Installed]
description = Detects installation of NalDrv or PROCEXP152 services via registry-keys to non-system32 folders. \
Both services are used in the tool Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs), which uses KDU (https://github.com/hfiref0x/KDU)
search = TargetObject IN ("HKLM\\System\\CurrentControlSet\\Services\\NalDrv\\ImagePath", "HKLM\\System\\CurrentControlSet\\Services\\PROCEXP152\\ImagePath") NOT (Image IN ("*\\procexp64.exe", "*\\procexp.exe", "*\\procmon64.exe", "*\\procmon.exe", "*\\handle.exe", "*\\handle64.exe") Details="*\\WINDOWS\\system32\\Drivers\\PROCEXP152.SYS*")

[Modify User Shell Folders Startup Value]
description = Detect modification of the startup key to a path where a payload could be stored to be launched during startup
search = TargetObject="*SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders*" TargetObject="*Startup"

[Enable LM Hash Storage]
description = Detects changes to the "NoLMHash" registry value in order to allow Windows to store LM Hashes. \
By setting this registry value to "0" (DWORD), Windows will be allowed to store a LAN manager hash of your password in Active Directory and local SAM databases.
search = TargetObject="*System\\CurrentControlSet\\Control\\Lsa\\NoLMHash" Details="DWORD (0x00000000)"

[Scheduled TaskCache Change by Uncommon Program]
description = Monitor the creation of a new key under 'TaskCache' when a new scheduled task is registered by a process that is not svchost.exe, which is suspicious
search = TargetObject="*SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\*" NOT (TargetObject IN ("*Microsoft\\Windows\\UpdateOrchestrator*", "*Microsoft\\Windows\\SoftwareProtectionPlatform\\SvcRestartTask\\Index*", "*Microsoft\\Windows\\Flighting\\OneSettings\\RefreshCache\\Index*") OR (Image="C:\\Windows\\*" Image="*\\TiWorker.exe") OR Image="C:\\WINDOWS\\system32\\svchost.exe" OR (Image="C:\\Windows\\Microsoft.NET\\Framework*" Image="*\\ngen.exe" TargetObject IN ("*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\{B66B135D-DA06-4FC4-95F8-7458E1D10129}*", "*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\Microsoft\\Windows\\.NET Framework\\.NET Framework NGEN*")) OR Image IN ("C:\\Program Files\\Microsoft Office\\root\\Integration\\Integrator.exe", "C:\\Program Files (x86)\\Microsoft Office\\root\\Integration\\Integrator.exe") OR Image="C:\\Windows\\System32\\msiexec.exe" OR Image IN ("C:\\Program Files (x86)\\Dropbox\\Update\\DropboxUpdate.exe", "C:\\Program Files\\Dropbox\\Update\\DropboxUpdate.exe") OR (Image="C:\\Windows\\explorer.exe" TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\Microsoft\\Windows\\PLA\\Server Manager Performance Monitor\\*") OR Image="System")

[Potential Registry Persistence Attempt Via Windows Telemetry]
description = Detects potential persistence behavior using the windows telemetry registry key. \
Windows telemetry makes use of the binary CompatTelRunner.exe to run a variety of commands and perform the actual telemetry collections. \
This binary was created to be easily extensible, and to that end, it relies on the registry to instruct on which commands to run. \
The problem is, it will run any arbitrary command without restriction of location or type.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\TelemetryController\\*" TargetObject="*\\Command" Details IN ("*.bat*", "*.bin*", "*.cmd*", "*.dat*", "*.dll*", "*.exe*", "*.hta*", "*.jar*", "*.js*", "*.msi*", "*.ps*", "*.sh*", "*.vb*") NOT (Details IN ("*\\system32\\CompatTelRunner.exe*", "*\\system32\\DeviceCensus.exe*"))

[RDP Sensitive Settings Changed to Zero]
description = Detects tampering of RDP Terminal Service/Server sensitive settings. \
Such as allowing unauthorized users access to a system via the 'fAllowUnsolicited' or enabling RDP via 'fDenyTSConnections', etc.
search = TargetObject IN ("*\\fDenyTSConnections", "*\\fSingleSessionPerUser", "*\\UserAuthentication") Details="DWORD (0x00000000)"

[RDP Sensitive Settings Changed]
description = Detects tampering of RDP Terminal Service/Server sensitive settings. \
Such as allowing unauthorized users access to a system via the 'fAllowUnsolicited' or enabling RDP via 'fDenyTSConnections'...etc
search = (TargetObject IN ("*\\Control\\Terminal Server\\*", "*\\Windows NT\\Terminal Services\\*") TargetObject="*\\Shadow" Details IN ("DWORD (0x00000001)", "DWORD (0x00000002)", "DWORD (0x00000003)", "DWORD (0x00000004)")) OR (TargetObject IN ("*\\Control\\Terminal Server\\*", "*\\Windows NT\\Terminal Services\\*") TargetObject IN ("*\\DisableRemoteDesktopAntiAlias", "*\\DisableSecuritySettings", "*\\fAllowUnsolicited", "*\\fAllowUnsolicitedFullControl") Details="DWORD (0x00000001)") OR TargetObject IN ("*\\Control\\Terminal Server\\InitialProgram*", "*\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\InitialProgram*", "*\\services\\TermService\\Parameters\\ServiceDll*", "*\\Windows NT\\Terminal Services\\InitialProgram*")

[New TimeProviders Registered With Uncommon DLL Name]
description = Detects processes setting a new DLL in DllName in under HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProvider. \
Adversaries may abuse time providers to execute DLLs when the system boots. \
The Windows Time service (W32Time) enables time synchronization across and within domains.
search = TargetObject="*\\Services\\W32Time\\TimeProviders*" TargetObject="*\\DllName" NOT (Details IN ("%SystemRoot%\\System32\\vmictimeprovider.dll", "%systemroot%\\system32\\w32time.dll", "C:\\Windows\\SYSTEM32\\w32time.DLL"))

[Old TLS1.0/TLS1.1 Protocol Version Enabled]
description = Detects applications or users re-enabling old TLS versions by setting the "Enabled" value to "1" for the "Protocols" registry key.
search = TargetObject IN ("*\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.0\\*", "*\\Control\\SecurityProviders\\SCHANNEL\\Protocols\\TLS 1.1\\*") TargetObject="*\\Enabled" Details="DWORD (0x00000001)"

[COM Hijacking via TreatAs]
description = Detect modification of TreatAs key to enable "rundll32.exe -sta" command
search = TargetObject="*TreatAs\\(Default)" NOT ((Image="C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*" Image="*\\OfficeClickToRun.exe") OR Image="C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe" OR Image="C:\\Windows\\system32\\svchost.exe" OR Image IN ("C:\\Windows\\system32\\msiexec.exe", "C:\\Windows\\SysWOW64\\msiexec.exe"))

[Potential Signing Bypass Via Windows Developer Features - Registry]
description = Detects when the enablement of developer features such as "Developer Mode" or "Application Sideloading". Which allows the user to install untrusted packages.
search = TargetObject IN ("*\\Microsoft\\Windows\\CurrentVersion\\AppModelUnlock*", "*\\Policies\\Microsoft\\Windows\\Appx\\*") TargetObject IN ("*\\AllowAllTrustedApps", "*\\AllowDevelopmentWithoutDevLicense") Details="DWORD (0x00000001)"

[UAC Bypass via Event Viewer]
description = Detects UAC bypass method using Windows event viewer
search = TargetObject="*\\mscfile\\shell\\open\\command"

[UAC Bypass Abusing Winsat Path Parsing - Registry]
description = Detects the pattern of UAC Bypass using a path parsing issue in winsat.exe (UACMe 52)
search = TargetObject="*\\Root\\InventoryApplicationFile\\winsat.exe|*" TargetObject="*\\LowerCaseLongPath" Details="c:\\users\\*" Details="*\\appdata\\local\\temp\\system32\\winsat.exe"

[UAC Bypass Using Windows Media Player - Registry]
description = Detects the pattern of UAC Bypass using Windows Media Player osksupport.dll (UACMe 32)
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Compatibility Assistant\\Store\\C:\\Program Files\\Windows Media Player\\osk.exe" Details="Binary Data"

[UAC Disabled]
description = Detects when an attacker tries to disable User Account Control (UAC) by setting the registry value "EnableLUA" to 0.
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\EnableLUA*" Details="DWORD (0x00000000)"

[UAC Notification Disabled]
description = Detects when an attacker tries to disable User Account Control (UAC) notification by tampering with the "UACDisableNotify" value. \
UAC is a critical security feature in Windows that prevents unauthorized changes to the operating system. It prompts the user for permission or an administrator password before allowing actions that could affect the system's operation or change settings that affect other users. \
When "UACDisableNotify" is set to 1, UAC prompts are suppressed.
search = TargetObject="*\\Microsoft\\Security Center\\UACDisableNotify*" Details="DWORD (0x00000001)"

[UAC Secure Desktop Prompt Disabled]
description = Detects when an attacker tries to change User Account Control (UAC) elevation request destination via the "PromptOnSecureDesktop" value. \
The "PromptOnSecureDesktop" setting specifically determines whether UAC prompts are displayed on the secure desktop. The secure desktop is a separate desktop environment that's isolated from other processes running on the system. It's designed to prevent malicious software from intercepting or tampering with UAC prompts. \
When "PromptOnSecureDesktop" is set to 0, UAC prompts are displayed on the user's current desktop instead of the secure desktop. This reduces the level of security because it potentially exposes the prompts to manipulation by malicious software.
search = TargetObject="*\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\PromptOnSecureDesktop*" Details="DWORD (0x00000000)"

[VBScript Payload Stored in Registry]
description = Detects VBScript content stored into registry keys as seen being used by UNC2452 group
search = TargetObject="*Software\\Microsoft\\Windows\\CurrentVersion*" Details IN ("*vbscript:*", "*jscript:*", "*mshtml,*", "*RunHTMLApplication*", "*Execute(*", "*CreateObject*", "*window.close*") NOT (TargetObject="*Software\\Microsoft\\Windows\\CurrentVersion\\Run*" OR (Image="*\\msiexec.exe" TargetObject="*\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Installer\\UserData\\*" Details IN ("*\\Microsoft.NET\\Primary Interop Assemblies\\Microsoft.mshtml.dll*", "*<\\Microsoft.mshtml,fileVersion=*", "*_mshtml_dll_*", "*<\\Microsoft.mshtml,culture=*")))

[Execution DLL of Choice Using WAB.EXE]
description = This rule detects that the path to the DLL written in the registry is different from the default one. Launched WAB.exe tries to load the DLL from Registry.
search = TargetObject="*\\Software\\Microsoft\\WAB\\DLLPath" NOT Details="%CommonProgramFiles%\\System\\wab32.dll"

[Wdigest Enable UseLogonCredential]
description = Detects potential malicious modification of the property value of UseLogonCredential from HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest to enable clear-text credentials
search = TargetObject="*WDigest\\UseLogonCredential" Details="DWORD (0x00000001)"

[Winget Admin Settings Modification]
description = Detects changes to the AppInstaller (winget) admin settings. Such as enabling local manifest installations or disabling installer hash checks
search = Image="*\\winget.exe" TargetObject="\\REGISTRY\\A\\*" TargetObject="*\\LocalState\\admin_settings"

[Enable Local Manifest Installation With Winget]
description = Detects changes to the AppInstaller (winget) policy. Specifically the activation of the local manifest installation, which allows a user to install new packages via custom manifests.
search = TargetObject="*\\AppInstaller\\EnableLocalManifestFiles" Details="DWORD (0x00000001)"

[Winlogon AllowMultipleTSSessions Enable]
description = Detects when the 'AllowMultipleTSSessions' value is enabled. \
Which allows for multiple Remote Desktop connection sessions to be opened at once. \
This is often used by attacker as a way to connect to an RDP session without disconnecting the other users
search = TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\AllowMultipleTSSessions" Details="*DWORD (0x00000001)"

[Winlogon Notify Key Logon Persistence]
description = Adversaries may abuse features of Winlogon to execute DLLs and/or executables when a user logs in. \
Winlogon.exe is a Windows component responsible for actions at logon/logoff as well as the secure attention sequence (SAS) triggered by Ctrl-Alt-Delete.
search = TargetObject="*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Notify\\logon" Details="*.dll"
